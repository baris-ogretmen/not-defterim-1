<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barış'ın Akıllı Not Defteri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Çeşitli yazı stilleri için -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Kalam:wght@300;400;700&family=Merriweather:wght@300;400;700&family=Courier+Prime:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Nesneleri
        window.firebaseData = { db: null, auth: null, user: null, active: false };

        const savedApiKey = localStorage.getItem('fb_api_key');
        const savedAppId = localStorage.getItem('fb_app_id');
        const defaultProject = "sekilli-totem-481514-c5";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: savedApiKey || "DEMO_KEY", 
            authDomain: `${defaultProject}.firebaseapp.com`,
            projectId: defaultProject,
            storageBucket: `${defaultProject}.firebasestorage.app`,
            messagingSenderId: "519295049418",
            appId: savedAppId || "DEMO_APP_ID"
        };

        async function initApp() {
            // Önce yerel verileri yükle (Offline Öncelikli)
            window.loadLocalNotes();

            if (firebaseConfig.apiKey === "DEMO_KEY" || firebaseConfig.apiKey.includes("BURAYA")) {
                console.log("Firebase API Key eksik, yerel modda devam ediliyor.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                window.firebaseData.auth = auth;
                window.firebaseData.db = db;

                // Auth Başlat
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    window.firebaseData.user = user;
                    if (user) {
                        window.firebaseData.active = true;
                        document.getElementById('cloud-icon').classList.replace('text-gray-300', 'text-green-500');
                        initLiveListener(user.uid);
                    }
                });
            } catch (e) {
                console.error("Firebase Hatası:", e);
            }
        }

        let unsubscribe = null;
        function initLiveListener(uid) {
            if (unsubscribe) unsubscribe();
            const q = collection(window.firebaseData.db, 'artifacts', defaultProject, 'users', uid, 'notes');
            unsubscribe = onSnapshot(q, (snapshot) => {
                const cloudNotes = [];
                snapshot.forEach(d => cloudNotes.push({ id: d.id, ...d.data() }));
                // Buluttan gelen veriyle yereli birleştir
                window.syncNotes(cloudNotes);
            }, (err) => {
                console.error("Veri okuma hatası:", err);
            });
        }

        // Başlat
        initApp();

        // CRUD Global Fonksiyonlar
        window.saveNoteToStorage = async (note) => {
            // 1. Yerele Kaydet
            const localNote = { ...note, id: note.id || 'loc_' + Date.now(), updatedAt: Date.now() };
            const existingIdx = window.localNotes.findIndex(n => n.id === note.id);
            
            if (existingIdx > -1) window.localNotes[existingIdx] = localNote;
            else window.localNotes.push(localNote);
            
            window.saveLocalToDisk();

            // 2. Buluta Kaydet (Varsa)
            if (window.firebaseData.active) {
                try {
                    const col = collection(window.firebaseData.db, 'artifacts', defaultProject, 'users', window.firebaseData.user.uid, 'notes');
                    // Eğer ID "loc_" ile başlıyorsa yeni doküman, değilse güncelleme
                    if (note.id && !note.id.startsWith('loc_')) {
                        await updateDoc(doc(col, note.id), { ...note, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(col, { ...note, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                    }
                } catch(e) { console.error("Bulut kaydı hatası:", e); }
            }
        };

        window.deleteNoteFromStorage = async (id) => {
            window.localNotes = window.localNotes.filter(n => n.id !== id);
            window.saveLocalToDisk();

            if (window.firebaseData.active && !id.startsWith('loc_')) {
                try {
                    await deleteDoc(doc(window.firebaseData.db, 'artifacts', defaultProject, 'users', window.firebaseData.user.uid, 'notes', id));
                } catch(e) { console.error("Bulut silme hatası:", e); }
            }
        };

    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Daha açık, temiz arka plan */
            background-image: 
                linear-gradient(rgba(226, 232, 240, 0.6) 1px, transparent 1px),
                linear-gradient(90deg, rgba(226, 232, 240, 0.6) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Font Aileleri */
        .font-hand { font-family: 'Kalam', cursive; }
        .font-serif { font-family: 'Merriweather', serif; }
        .font-mono { font-family: 'Courier Prime', monospace; }
        .font-sans { font-family: 'Inter', sans-serif; }

        /* Kart Stilleri */
        .note-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .note-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        /* Kategori Renkleri (Hafif ve Modern) */
        .cat-tarih { background: #fee2e2; color: #7f1d1d; border-top: 6px solid #ef4444; }
        .cat-dini { background: #dcfce7; color: #14532d; border-top: 6px solid #22c55e; }
        .cat-siyasi { background: #dbeafe; color: #1e3a8a; border-top: 6px solid #3b82f6; }
        .cat-egitim { background: #fef3c7; color: #78350f; border-top: 6px solid #f59e0b; }
        .cat-guncel { background: #cffafe; color: #155e75; border-top: 6px solid #06b6d4; }
        .cat-kisisel { background: #fae8ff; color: #701a75; border-top: 6px solid #d946ef; }
        .cat-is { background: #f1f5f9; color: #334155; border-top: 6px solid #64748b; }
        .cat-diger { background: #f3f4f6; color: #1f2937; border-top: 6px solid #9ca3af; }

        /* FAB (Yüzen Buton) */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #4f46e5;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            z-index: 40;
        }
        .fab:active { transform: scale(0.90); }

        /* Modal Toolbar */
        .editor-toolbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-top: 1px solid #e5e7eb;
        }

        /* Gizli Mod */
        body.stealth-mode { background: #000 !important; overflow: hidden; }
        body.stealth-mode header, body.stealth-mode main, body.stealth-mode .fab { opacity: 0; pointer-events: none; }
        body.stealth-mode #stealth-overlay { display: flex; }

        /* Animasyonlar */
        @keyframes micPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
        .mic-active { animation: micPulse 1.5s infinite; background-color: #fee2e2 !important; color: #ef4444 !important; border-color: #ef4444 !important; }
        .loader { width: 24px; height: 24px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-200">
                    <i data-lucide="book-open-check" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-gray-800">Barış'ın Defteri</h1>
            </div>
            
            <div class="flex items-center gap-1">
                <i data-lucide="cloud" id="cloud-icon" class="w-5 h-5 text-gray-300 mr-2 transition-colors"></i>
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="openWhatsAppMode()" class="p-2 rounded-full hover:bg-green-50 text-green-600"><i data-lucide="smartphone" class="w-5 h-5"></i></button>
                <button onclick="toggleStealth()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="eye-off" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Kategoriler -->
        <div class="overflow-x-auto py-2 px-4 no-scrollbar">
            <div class="flex gap-2 max-w-5xl mx-auto min-w-max">
                <button onclick="filter('all')" class="cat-btn active bg-gray-800 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-md transition-all">Tümü</button>
                <button onclick="filter('tarih')" class="cat-btn bg-white border text-red-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-red-50 transition-all">Tarih</button>
                <button onclick="filter('dini')" class="cat-btn bg-white border text-green-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-green-50 transition-all">Dini</button>
                <button onclick="filter('siyasi')" class="cat-btn bg-white border text-blue-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-blue-50 transition-all">Siyasi</button>
                <button onclick="filter('egitim')" class="cat-btn bg-white border text-yellow-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-yellow-50 transition-all">Eğitim</button>
                <button onclick="filter('guncel')" class="cat-btn bg-white border text-cyan-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-cyan-50 transition-all">Güncel</button>
                <button onclick="filter('is')" class="cat-btn bg-white border text-slate-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-slate-50 transition-all">İş</button>
                <button onclick="filter('diger')" class="cat-btn bg-white border text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-gray-50 transition-all">Diğer</button>
            </div>
        </div>
    </header>

    <!-- Ana Alan -->
    <main class="flex-1 overflow-y-auto p-4 pb-24">
        <div class="max-w-5xl mx-auto space-y-6">
            <!-- Arama -->
            <div class="relative group">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
                <input type="text" id="searchInput" onkeyup="search()" placeholder="Notlarda ara..." class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl shadow-sm border-none focus:ring-2 focus:ring-indigo-100 transition-all outline-none placeholder-gray-400 font-medium">
            </div>

            <!-- Liste -->
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            
            <div id="empty-state" class="hidden text-center py-20 opacity-50">
                <i data-lucide="feather" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                <p class="text-xl font-hand">Henüz not yok, hemen bir şeyler karala!</p>
            </div>
        </div>
    </main>

    <!-- FAB (Ekleme Butonu) -->
    <button onclick="openModal()" class="fab">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <!-- NOT DÜZENLEME MODALI -->
    <div id="note-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:top-10 md:bottom-10 md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-2xl bg-white rounded-t-3xl md:rounded-3xl shadow-2xl flex flex-col overflow-hidden transition-transform duration-300 translate-y-full" id="modal-panel">
            
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white z-10">
                <input type="text" id="note-title" placeholder="Başlık" class="text-xl font-bold bg-transparent border-none focus:ring-0 p-0 w-full text-gray-800 placeholder-gray-300">
                <div class="flex gap-2">
                    <button onclick="deleteCurrentNote()" id="btn-delete" class="hidden text-red-400 hover:bg-red-50 p-2 rounded-full"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    <button onclick="saveNote()" class="bg-black text-white px-5 py-2 rounded-full text-sm font-bold shadow-lg active:scale-95 transition-transform">Kaydet</button>
                </div>
            </div>

            <!-- Kategori Seçimi -->
            <div class="px-6 py-2 bg-gray-50/50 flex gap-2 overflow-x-auto no-scrollbar" id="modal-cats"></div>

            <!-- Editör Alanı -->
            <div class="flex-1 relative bg-white group">
                <textarea id="note-content" class="w-full h-full p-6 resize-none bg-transparent border-none focus:ring-0 text-lg leading-relaxed placeholder-gray-300 font-hand text-gray-700" placeholder="Buraya yazın..."></textarea>
                
                <!-- AI Yükleniyor -->
                <div id="ai-loading" class="absolute inset-0 bg-white/80 z-20 hidden flex-col items-center justify-center">
                    <div class="loader mb-3"></div>
                    <p class="text-sm font-bold text-indigo-600 animate-pulse">Yapay Zeka Çalışıyor...</p>
                </div>
            </div>

            <!-- Alt Toolbar (Format & AI & Ses) -->
            <div class="editor-toolbar p-3 pb-safe">
                <div class="flex justify-between items-center max-w-lg mx-auto">
                    <!-- Font Seçici -->
                    <div class="flex gap-1">
                        <button onclick="setFont('font-hand')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-hand" title="El Yazısı">Aa</button>
                        <button onclick="setFont('font-serif')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-serif" title="Kitap">Aa</button>
                        <button onclick="setFont('font-sans')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-sans" title="Modern">Aa</button>
                        <button onclick="setFont('font-mono')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-mono" title="Daktilo">Aa</button>
                    </div>

                    <div class="w-px h-6 bg-gray-200 mx-2"></div>

                    <!-- AI ve Ses -->
                    <div class="flex gap-2">
                        <button onclick="toggleVoice()" id="mic-btn" class="p-3 rounded-full bg-red-50 text-red-500 hover:bg-red-100 transition-colors"><i data-lucide="mic" class="w-5 h-5"></i></button>
                        <div class="relative">
                            <button onclick="toggleAiMenu()" class="p-3 rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors shadow-sm"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                            <!-- AI Popup -->
                            <div id="ai-popup" class="absolute bottom-14 right-0 w-48 bg-white rounded-xl shadow-xl border border-gray-100 p-2 hidden z-30">
                                <button onclick="runAI('fix')" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Düzelt</button>
                                <button onclick="runAI('summarize')" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4 text-blue-500"></i> Özetle</button>
                                <button onclick="runAI('expand')" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm flex items-center gap-2"><i data-lucide="maximize" class="w-4 h-4 text-purple-500"></i> Genişlet</button>
                                <button onclick="openWhatsAppMode()" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm flex items-center gap-2 border-t mt-1 pt-2"><i data-lucide="smartphone" class="w-4 h-4 text-green-600"></i> WhatsApp</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div id="wp-modal" class="fixed inset-0 z-[60] hidden bg-black/90 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-gray-900 rounded-3xl overflow-hidden shadow-2xl flex flex-col h-[80vh]">
            <div class="p-4 flex justify-between items-center">
                <button onclick="closeWp()" class="text-white"><i data-lucide="x"></i></button>
                <span class="text-xs font-mono text-gray-400" id="wp-count">0/700</span>
            </div>
            <div id="wp-preview" class="flex-1 flex items-center justify-center p-6 transition-colors duration-500" style="background-color: #25D366;">
                <textarea id="wp-text" class="w-full bg-transparent border-none text-center text-white text-2xl font-['Patrick_Hand'] focus:ring-0 resize-none" rows="8" oninput="checkWpLimit()"></textarea>
            </div>
            <div class="p-4 bg-gray-800 space-y-3">
                <div class="flex justify-center gap-3">
                    <button onclick="setWpColor('#25D366')" class="w-6 h-6 rounded-full bg-[#25D366] border border-white/20"></button>
                    <button onclick="setWpColor('#FF5252')" class="w-6 h-6 rounded-full bg-[#FF5252] border border-white/20"></button>
                    <button onclick="setWpColor('#448AFF')" class="w-6 h-6 rounded-full bg-[#448AFF] border border-white/20"></button>
                    <button onclick="setWpColor('#7C4DFF')" class="w-6 h-6 rounded-full bg-[#7C4DFF] border border-white/20"></button>
                    <button onclick="setWpColor('#212121')" class="w-6 h-6 rounded-full bg-[#212121] border border-white/20"></button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="runAI('whatsapp')" class="bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> AI Sığdır</button>
                    <button onclick="saveWpToNote()" class="bg-gray-700 text-white py-2 rounded-lg text-sm font-bold">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ayarlar Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl">
            <h2 class="text-xl font-bold mb-4">Ayarlar</h2>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key (AI İçin)</label>
                <input type="password" id="gemini-key" class="w-full border rounded-lg p-2 text-sm" placeholder="AIzaSy...">
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Firebase Config (Bulut İçin)</label>
                <input type="password" id="fb-key" class="w-full border rounded-lg p-2 text-sm mb-2" placeholder="API Key">
                <input type="text" id="fb-app" class="w-full border rounded-lg p-2 text-sm" placeholder="App ID">
            </div>

            <div class="flex justify-between">
                <button onclick="downloadBackup()" class="text-green-600 text-sm font-bold flex items-center"><i data-lucide="download" class="w-4 h-4 mr-1"></i> Yedekle</button>
                <div class="flex gap-2">
                    <button onclick="toggleSettings()" class="text-gray-500 text-sm">İptal</button>
                    <button onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[80] space-y-2 pointer-events-none"></div>

    <!-- Gizli Mod Overlay -->
    <div id="stealth-overlay" class="fixed inset-0 bg-black z-[100] hidden flex flex-col items-center justify-center text-gray-800 text-xs select-none" onclick="toggleStealth()">
        <div class="mb-4 animate-pulse">● Kayıt</div>
        <p>Çıkmak için dokun</p>
        <div id="stealth-text" class="mt-4 opacity-10 max-w-xs text-center truncate"></div>
    </div>

    <script>
        // --- Durum Yönetimi ---
        let notes = [];
        let currentFilter = 'all';
        let currentNoteId = null;
        let recognition = null;
        let isListening = false;
        let currentFont = 'font-hand';
        let currentCat = 'guncel';

        const CATEGORIES = {
            'tarih': 'Tarih', 'dini': 'Dini', 'siyasi': 'Siyasi', 
            'egitim': 'Eğitim', 'guncel': 'Güncel', 'is': 'İş', 
            'kisisel': 'Kişisel', 'diger': 'Diğer'
        };

        // --- Başlangıç ---
        document.addEventListener('DOMContentLoaded', () => {
            window.loadLocalNotes();
            setupVoice();
            lucide.createIcons();
            
            // Ayarları form içine doldur
            document.getElementById('gemini-key').value = localStorage.getItem('gemini_api_key') || "";
            document.getElementById('fb-key').value = localStorage.getItem('fb_api_key') || "";
            document.getElementById('fb-app').value = localStorage.getItem('fb_app_id') || "";
        });

        // --- Veri ---
        window.loadLocalNotes = () => {
            const saved = localStorage.getItem('baris_notes');
            if (saved) {
                window.localNotes = JSON.parse(saved);
                render(window.localNotes);
            } else {
                window.localNotes = [];
                render([]);
            }
        };

        window.saveLocalToDisk = () => {
            localStorage.setItem('baris_notes', JSON.stringify(window.localNotes));
            render(window.localNotes);
        };

        window.syncNotes = (cloudNotes) => {
            // Basit birleştirme (Bulut verisini öncelikli al)
            const noteMap = new Map();
            window.localNotes.forEach(n => noteMap.set(n.id, n));
            cloudNotes.forEach(n => noteMap.set(n.id, n));
            window.localNotes = Array.from(noteMap.values());
            window.saveLocalToDisk();
        };

        // --- Arayüz ---
        function render(data) {
            const grid = document.getElementById('notes-grid');
            const empty = document.getElementById('empty-state');
            grid.innerHTML = '';

            const filtered = data.filter(n => currentFilter === 'all' || n.category === currentFilter)
                                 .sort((a,b) => (b.updatedAt?.seconds || b.updatedAt) - (a.updatedAt?.seconds || a.updatedAt));

            if (filtered.length === 0) {
                empty.classList.remove('hidden');
                return;
            } else {
                empty.classList.add('hidden');
            }

            filtered.forEach(note => {
                const el = document.createElement('div');
                const catClass = `cat-${note.category || 'diger'}`;
                const fontClass = note.font || 'font-hand';
                const date = new Date((note.updatedAt?.seconds || note.updatedAt / 1000) * 1000).toLocaleDateString('tr-TR');

                el.className = `note-card ${catClass} cursor-pointer flex flex-col h-48 animate-fade-in bg-white`;
                el.innerHTML = `
                    <div class="p-4 flex-1 overflow-hidden relative group" onclick="openNote('${note.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg leading-tight line-clamp-2">${note.title || 'Başlıksız'}</h3>
                            <span class="text-[10px] uppercase font-bold opacity-50 border border-current px-1 rounded">${CATEGORIES[note.category]}</span>
                        </div>
                        <p class="text-sm opacity-80 ${fontClass} line-clamp-4 whitespace-pre-line">${note.content || ''}</p>
                        <span class="absolute bottom-3 right-4 text-xs opacity-40">${date}</span>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        function filter(cat) {
            currentFilter = cat;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.remove('bg-gray-800', 'text-white');
                b.classList.add('bg-white');
            });
            const btn = Array.from(document.querySelectorAll('.cat-btn')).find(b => b.innerText === CATEGORIES[cat] || (cat === 'all' && b.innerText === 'Tümü'));
            if(btn) {
                btn.classList.add('bg-gray-800', 'text-white');
                btn.classList.remove('bg-white');
            }
            render(window.localNotes);
        }

        function search() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtered = window.localNotes.filter(n => (n.title+n.content).toLowerCase().includes(val));
            const grid = document.getElementById('notes-grid');
            grid.innerHTML = ''; 
            // Render logic duplicate for search simplicity
            if(filtered.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else {
                document.getElementById('empty-state').classList.add('hidden');
                filtered.forEach(note => {
                    // (Same render logic card creation - simplified for brevity)
                    const el = document.createElement('div');
                    el.className = `note-card cat-${note.category} cursor-pointer flex flex-col h-48 bg-white`;
                    el.innerHTML = `<div class="p-4" onclick="openNote('${note.id}')"><h3 class="font-bold">${note.title}</h3><p class="text-sm mt-2 line-clamp-4">${note.content}</p></div>`;
                    grid.appendChild(el);
                });
            }
        }

        // --- Modal & Editör ---
        function openModal() {
            currentNoteId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('btn-delete').classList.add('hidden');
            renderCats('guncel');
            setFont('font-hand');
            document.getElementById('note-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-panel').classList.remove('translate-y-full'), 10);
        }

        function openNote(id) {
            const note = window.localNotes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('note-content').value = note.content || '';
            document.getElementById('btn-delete').classList.remove('hidden');
            renderCats(note.category || 'guncel');
            setFont(note.font || 'font-hand');
            
            document.getElementById('note-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-panel').classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            document.getElementById('modal-panel').classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('note-modal').classList.add('hidden');
                document.getElementById('ai-popup').classList.add('hidden');
                if(isListening) toggleVoice();
            }, 300);
        }

        function renderCats(selected) {
            currentCat = selected;
            const div = document.getElementById('modal-cats');
            div.innerHTML = '';
            Object.keys(CATEGORIES).forEach(k => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded-full text-xs font-bold border transition-all whitespace-nowrap ${k === selected ? 'bg-gray-800 text-white' : 'bg-white text-gray-500'}`;
                btn.innerText = CATEGORIES[k];
                btn.onclick = () => { renderCats(k); };
                div.appendChild(btn);
            });
        }

        function setFont(fontClass) {
            currentFont = fontClass;
            const area = document.getElementById('note-content');
            area.className = area.className.replace(/font-\w+/, fontClass);
        }

        async function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value.trim();
            if (!title && !content) return showToast('Boş not kaydedilemez', 'error');

            const noteData = {
                id: currentNoteId, // Varsa ID
                title, content, 
                category: currentCat,
                font: currentFont
            };

            await window.saveNoteToStorage(noteData);
            closeModal();
            showToast('Kaydedildi', 'success');
        }

        async function deleteCurrentNote() {
            if(confirm("Bu notu silmek istiyor musun?")) {
                await window.deleteNoteFromStorage(currentNoteId);
                closeModal();
                showToast('Silindi', 'success');
            }
        }

        // --- Yapay Zeka (Gemini) ---
        function toggleAiMenu() { document.getElementById('ai-popup').classList.toggle('hidden'); }

        async function runAI(action) {
            toggleAiMenu(); // Menüyü kapat
            const content = document.getElementById('note-content').value;
            if(!content) return showToast("Önce bir şeyler yazmalısın!", "error");

            const apiKey = localStorage.getItem('gemini_api_key');
            if(!apiKey) return showToast("Ayarlardan API Anahtarı girmelisin!", "error");

            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('ai-loading').classList.add('flex');

            let prompt = "";
            if (action === 'fix') prompt = `Bu metni Türkçe imla kurallarına göre düzelt ve daha akıcı hale getir:\n\n${content}`;
            else if (action === 'summarize') prompt = `Bu metni Türkçe olarak kısa maddeler halinde özetle:\n\n${content}`;
            else if (action === 'expand') prompt = `Bu metindeki ana fikri koruyarak daha detaylı, edebi ve zengin bir şekilde genişlet (Türkçe):\n\n${content}`;
            else if (action === 'whatsapp') {
                prompt = `Bu metni WhatsApp durumu (max 700 karakter) için kısalt, duygusuna uygun emojiler ekle ve arka plan rengi seç (1-5 arası sayı). Cevap formatı: METİN|||RENK_NO (1:Yeşil, 2:Kırmızı, 3:Mavi, 4:Mor, 5:Siyah). Metin: ${content}`;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                
                if(data.error) throw new Error(data.error.message);

                const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (action === 'whatsapp') {
                    // WhatsApp özel işleme
                    const parts = result.split('|||');
                    document.getElementById('wp-text').value = parts[0].trim();
                    if(parts[1]) {
                        const colors = ['#25D366', '#FF5252', '#448AFF', '#7C4DFF', '#212121'];
                        setWpColor(colors[parseInt(parts[1])-1] || colors[0]);
                    }
                    closeModal(); // Not modalını kapat
                    document.getElementById('wp-modal').classList.remove('hidden'); // WP modalını aç
                } else {
                    // Normal not güncelleme
                    document.getElementById('note-content').value = result;
                }
                
                showToast("Yapay Zeka tamamladı!", "success");

            } catch (error) {
                console.error(error);
                showToast("AI Hatası: " + error.message, "error");
            } finally {
                document.getElementById('ai-loading').classList.add('hidden');
                document.getElementById('ai-loading').classList.remove('flex');
            }
        }

        // --- WhatsApp Studio ---
        function openWhatsAppMode() {
            // Eğer not modalı açıksa oradaki metni al
            const currentContent = document.getElementById('note-content').value;
            document.getElementById('wp-text').value = currentContent;
            checkWpLimit();
            document.getElementById('wp-modal').classList.remove('hidden');
        }
        function closeWp() { document.getElementById('wp-modal').classList.add('hidden'); }
        function setWpColor(c) { document.getElementById('wp-preview').style.backgroundColor = c; }
        function checkWpLimit() {
            const len = document.getElementById('wp-text').value.length;
            document.getElementById('wp-count').innerText = `${len}/700`;
            document.getElementById('wp-count').className = len > 700 ? "text-red-500 font-bold" : "text-gray-400 font-mono";
        }
        function saveWpToNote() {
            const text = document.getElementById('wp-text').value;
            if(!currentNoteId) {
                // Yeni not
                window.saveNoteToStorage({title: 'Durum Yazısı', content: text, category: 'diger', font: 'font-hand'});
            } else {
                // Mevcut notu güncelle
                document.getElementById('note-content').value = text;
                saveNote();
            }
            closeWp();
            showToast("Kaydedildi", "success");
        }

        // --- Ses ---
        function setupVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onresult = (e) => {
                    let final = '';
                    for (let i = e.resultIndex; i < e.results.length; ++i) if(e.results[i].isFinal) final += e.results[i][0].transcript;
                    if(final) {
                        const el = document.getElementById('note-content');
                        el.value += (el.value ? ' ' : '') + final;
                        if(isListening && document.body.classList.contains('stealth-mode')) {
                            document.getElementById('stealth-text').innerText = final;
                        }
                    }
                };
                recognition.onend = () => { if(isListening) try{recognition.start()}catch{} else updateMicState(false); };
            }
        }
        function toggleVoice() {
            if(!recognition) return showToast("Mikrofon desteklenmiyor", "error");
            isListening = !isListening;
            updateMicState(isListening);
            if(isListening) { try{ recognition.start(); showToast("Dinliyorum...", "success"); }catch{} }
            else { try{ recognition.stop(); }catch{} }
        }
        function updateMicState(on) {
            const btn = document.getElementById('mic-btn');
            if(on) {
                btn.classList.add('mic-active', 'bg-red-100', 'text-red-600');
                btn.innerHTML = '<i data-lucide="mic-off"></i>';
            } else {
                btn.classList.remove('mic-active', 'bg-red-100', 'text-red-600');
                btn.innerHTML = '<i data-lucide="mic"></i>';
            }
            lucide.createIcons();
        }

        // --- Ayarlar & Yedek ---
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function saveSettings() {
            localStorage.setItem('gemini_api_key', document.getElementById('gemini-key').value.trim());
            localStorage.setItem('fb_api_key', document.getElementById('fb-key').value.trim());
            localStorage.setItem('fb_app_id', document.getElementById('fb-app').value.trim());
            toggleSettings();
            showToast("Ayarlar kaydedildi, sayfayı yenileyin", "success");
            setTimeout(() => location.reload(), 1000);
        }
        function downloadBackup() {
            const blob = new Blob([JSON.stringify(window.localNotes, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `yedek-${Date.now()}.json`;
            a.click();
        }

        function toggleStealth() {
            document.body.classList.toggle('stealth-mode');
            if(document.body.classList.contains('stealth-mode')) {
                if(!isListening) toggleVoice();
            }
        }

        // Toast
        function showToast(msg, type) {
            const div = document.createElement('div');
            div.className = `px-4 py-2 rounded-lg shadow-lg text-white text-sm font-bold animate-fade-in ${type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            div.innerText = msg;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>


