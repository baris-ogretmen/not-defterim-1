<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BarÄ±ÅŸ'Ä±n AkÄ±llÄ± Not Defteri Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Kalam:wght@300;400;700&family=Merriweather:wght@300;400;700;900&family=Courier+Prime:wght@400;700&family=Patrick+Hand&family=Caveat:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Oswald:wght@400;700&family=Roboto+Mono:wght@400;700&family=Pacifico&family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --app-bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: var(--app-bg); background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 32px 32px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; touch-action: manipulation; }

        /* Fontlar */
        .font-hand { font-family: 'Kalam', cursive; }
        .font-serif { font-family: 'Merriweather', serif; }
        .font-mono { font-family: 'Courier Prime', monospace; }
        .font-sans { font-family: 'Inter', sans-serif; }
        .font-caveat { font-family: 'Caveat', cursive; }
        .font-lora { font-family: 'Lora', serif; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-roboto { font-family: 'Roboto Mono', monospace; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .font-comfortaa { font-family: 'Comfortaa', cursive; }

        .hidden { display: none !important; }
        [contenteditable]:empty:before { content: attr(placeholder); color: #9ca3af; display: block; font-style: italic; }
        
        /* Not KartÄ± */
        .note-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; border-radius: 20px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; background: white; }
        .note-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); z-index: 10; }
        
        /* Kategori Renkleri (Tag & Border) */
        .theme-tarih { border-color: #ef4444; color: #dc2626; background-color: #fef2f2; }
        .theme-dini { border-color: #22c55e; color: #16a34a; background-color: #f0fdf4; }
        .theme-siyasi { border-color: #3b82f6; color: #2563eb; background-color: #eff6ff; }
        .theme-egitim { border-color: #f59e0b; color: #d97706; background-color: #fffbeb; }
        .theme-guncel { border-color: #06b6d4; color: #0891b2; background-color: #ecfeff; }
        .theme-kisisel { border-color: #d946ef; color: #c026d3; background-color: #fdf4ff; }
        .theme-is { border-color: #64748b; color: #475569; background-color: #f8fafc; }
        .theme-diger { border-color: #9ca3af; color: #4b5563; background-color: #f9fafb; }

        /* Kart Ãœst Ã‡izgileri */
        .cat-border-tarih { border-top: 6px solid #ef4444; }
        .cat-border-dini { border-top: 6px solid #22c55e; }
        .cat-border-siyasi { border-top: 6px solid #3b82f6; }
        .cat-border-egitim { border-top: 6px solid #f59e0b; }
        .cat-border-guncel { border-top: 6px solid #06b6d4; }
        .cat-border-kisisel { border-top: 6px solid #d946ef; }
        .cat-border-is { border-top: 6px solid #64748b; }
        .cat-border-diger { border-top: 6px solid #9ca3af; }

        /* FAB - MOBÄ°L GÃ–RÃœNÃœRLÃœK Ä°Ã‡Ä°N GÃœNCELLENDÄ° (z-index artÄ±rÄ±ldÄ±, bottom safe area eklendi) */
        .fab { position: fixed; bottom: max(40px, env(safe-area-inset-bottom) + 20px); right: 24px; width: 68px; height: 68px; border-radius: 50%; background: #4f46e5; color: white; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5); display: flex; align-items: center; justify-content: center; z-index: 95; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }

        /* Modal */
        #modal-panel { display: flex; flex-direction: column; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .bottom-toolbar-container { background: rgba(255,255,255,0.96); backdrop-filter: blur(15px); border-top: 1px solid #f1f5f9; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -10px 30px rgba(0,0,0,0.03); z-index: 50; }

        /* Animasyon */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* AI Vurgu Stilleri (Eski formatlara destek iÃ§in) */
        .highlight-red { color: #dc2626; font-weight: 800; }
        .highlight-blue { color: #2563eb; font-weight: 800; }
        .highlight-marker { background-color: #fef08a; padding: 0 2px; border-radius: 4px; }

        /* Screenshot Mode */
        .screenshot-mode { position: fixed !important; inset: 0 !important; background: white !important; z-index: 9999 !important; border-radius: 0 !important; width: 100vw !important; height: auto !important; min-height: 100vh !important; overflow: visible !important; }
        .screenshot-mode .hide-on-capture { display: none !important; }
        .screenshot-mode #note-content { font-size: 1.25rem !important; line-height: 2 !important; padding: 40px !important; }
        .screenshot-mode #note-title { font-size: 2.5rem !important; text-align: center; margin-bottom: 2rem; }

        /* MenÃ¼ler */
        .floating-pill { position: fixed; z-index: 2000; background: white; padding: 6px; border-radius: 99px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); border: 1px solid #e5e7eb; display: flex; gap: 8px; transform: translate(-50%, -100%); }
        .context-menu { position: fixed; z-index: 2001; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid #e2e8f0; width: 280px; overflow: hidden; }
        
        #font-menu { bottom: 90px; left: 20px; max-height: 50vh; overflow-y: auto; }
        #ai-menu { bottom: 90px; right: 20px; max-height: 65vh; overflow-y: auto; }
        #color-grid { width: 300px; max-height: 300px; overflow-y: auto; }

        .loader { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="selection:bg-indigo-100">

    <!-- HEADER -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100 shrink-0">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="p-2.5 bg-indigo-600 rounded-2xl text-white shadow-xl shadow-indigo-200">
                    <i data-lucide="book-open-check" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight text-gray-800">BarÄ±ÅŸ'Ä±n Defteri</h1>
                    <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">Ultimate v107</p>
                </div>
            </div>
            <div class="flex items-center gap-1.5">
                <button onclick="openYouTubeMode()" class="p-2.5 bg-red-50 text-red-600 rounded-xl border border-red-100 hover:bg-red-100 transition-colors" title="YouTube AsistanÄ±"><i data-lucide="youtube" class="w-5 h-5"></i></button>
                <button onclick="copyAllNotes()" class="p-2.5 bg-blue-50 text-blue-600 rounded-xl border border-blue-100 hover:bg-blue-100 transition-colors" title="Yedek Al"><i data-lucide="download" class="w-5 h-5"></i></button>
                <button onclick="toggleSettings()" class="p-2.5 bg-slate-50 text-slate-600 rounded-xl border border-slate-100 hover:bg-slate-100 transition-colors" title="Ayarlar"><i data-lucide="settings" class="w-5 h-5"></i></button>
            </div>
        </div>
        <!-- Kategori BarÄ± -->
        <div class="overflow-x-auto py-2 px-4 no-scrollbar flex gap-2 max-w-5xl mx-auto">
            <button onclick="filterNotes('all')" class="cat-filter-btn bg-gray-800 text-white px-5 py-2 rounded-full text-xs font-bold shadow-md whitespace-nowrap">TÃ¼mÃ¼</button>
            <button onclick="filterNotes('tarih')" class="cat-filter-btn bg-white border text-red-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">Tarih</button>
            <button onclick="filterNotes('dini')" class="cat-filter-btn bg-white border text-green-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">Dini</button>
            <button onclick="filterNotes('egitim')" class="cat-filter-btn bg-white border text-yellow-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">EÄŸitim</button>
            <button onclick="filterNotes('siyasi')" class="cat-filter-btn bg-white border text-blue-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">Siyasi</button>
            <button onclick="filterNotes('guncel')" class="cat-filter-btn bg-white border text-cyan-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">GÃ¼ncel</button>
            <button onclick="filterNotes('kisisel')" class="cat-filter-btn bg-white border text-fuchsia-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">KiÅŸisel</button>
            <button onclick="filterNotes('is')" class="cat-filter-btn bg-white border text-slate-600 px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap">Ä°ÅŸ</button>
        </div>
    </header>

    <!-- ANA Ä°Ã‡ERÄ°K -->
    <main class="flex-1 overflow-y-auto p-4 pb-32">
        <div class="max-w-5xl mx-auto space-y-6">
            <div class="relative group">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" onkeyup="renderNotes()" placeholder="Binlerce not arasÄ±ndan ara..." class="w-full pl-14 pr-6 py-4 bg-white rounded-2xl shadow-sm border-none focus:ring-2 focus:ring-indigo-100 outline-none font-medium">
            </div>
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
            <div id="empty-state" class="hidden text-center py-24 flex flex-col items-center opacity-40">
                <i data-lucide="feather" class="w-20 h-20 mb-4 text-gray-300"></i>
                <p class="text-lg font-hand">HenÃ¼z bir ÅŸey karalamamÄ±ÅŸsÄ±n BarÄ±ÅŸ Hoca...</p>
            </div>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="openNoteEditor()" class="fab hover:scale-110 active:scale-95 shadow-indigo-500/40"><i data-lucide="plus" class="w-9 h-9"></i></button>

    <!-- NOT EDÄ°TÃ–RÃœ -->
    <div id="note-modal" class="fixed inset-0 hidden z-[100]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeNoteEditor()"></div>
        <div id="modal-panel" class="absolute inset-0 md:top-10 md:inset-x-0 md:max-w-4xl md:mx-auto bg-white md:rounded-t-[32px] shadow-2xl translate-y-full">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-white sticky top-0 z-20 shrink-0 hide-on-capture">
                <button onclick="closeNoteEditor()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-down"></i></button>
                <div class="flex-1 px-4 relative group">
                    <div id="note-title" contenteditable="true" placeholder="Buna ne diyoruz?" class="text-xl font-bold bg-transparent border-none focus:ring-0 p-1 w-full outline-none empty:before:text-gray-300 pr-10"></div>
                    <button onclick="runAI('generate_title')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-300 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-indigo-50" title="AI ile BaÅŸlÄ±k OluÅŸtur"><i data-lucide="wand-2" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleScreenshotMode()" class="p-2 text-gray-400 hover:text-indigo-600"><i data-lucide="camera"></i></button>
                    <button id="btn-delete-note" class="p-2 text-red-400 hover:text-red-600 hidden" onclick="deleteCurrentNote()"><i data-lucide="trash-2"></i></button>
                    <button onclick="saveCurrentNote()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg shadow-indigo-200">Kaydet</button>
                </div>
            </div>
            <div class="px-6 py-3 bg-gray-50/50 flex items-center justify-between border-b hide-on-capture shrink-0">
                <div id="editor-cat-chips" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
                <span id="word-count" class="text-[10px] font-bold text-gray-400 uppercase">0 Kelime</span>
            </div>
            <div class="relative flex-1 overflow-hidden flex flex-col bg-white">
                <div id="note-content" contenteditable="true" class="w-full flex-1 p-8 outline-none text-lg leading-relaxed font-hand overflow-y-auto custom-scroll" placeholder="BarÄ±ÅŸ buraya dÃ¶ktÃ¼rÃ¼r..."></div>
                <div id="ai-loading" class="absolute inset-0 bg-white/90 z-[60] hidden flex-col items-center justify-center">
                    <div class="loader mb-4"></div>
                    <p class="text-sm font-bold text-indigo-600 animate-pulse uppercase tracking-widest">BarÄ±ÅŸ'Ä±n Yapay ZekasÄ± DÃ¼ÅŸÃ¼nÃ¼yor...</p>
                </div>
            </div>
            <div class="bottom-toolbar-container px-4 py-3 flex justify-between items-center hide-on-capture">
                <div class="flex items-center gap-1">
                    <button onmousedown="event.preventDefault()" onclick="execAction('undo')" class="p-2.5 text-gray-500 hover:bg-gray-100 rounded-xl"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                    <button onmousedown="event.preventDefault()" onclick="execAction('redo')" class="p-2.5 text-gray-500 hover:bg-gray-100 rounded-xl"><i data-lucide="redo-2" class="w-5 h-5"></i></button>
                    <div class="w-px h-6 bg-gray-200 mx-1"></div>
                    <button onclick="toggleMenu('font-menu')" class="flex items-center gap-1 font-bold text-gray-600 px-3 py-1.5 border rounded-xl hover:bg-gray-50 text-sm">Aa</button>
                </div>
                <div class="flex items-center gap-1.5">
                    <button onmousedown="event.preventDefault()" onclick="toggleReadMode()" class="p-2.5 rounded-xl text-gray-500 hover:bg-gray-100"><i data-lucide="glasses" class="w-5 h-5"></i></button>
                    <button onmousedown="event.preventDefault()" onclick="playTTS()" id="tts-btn" class="p-2.5 rounded-xl text-blue-500 hover:bg-blue-50"><i data-lucide="volume-2" class="w-5 h-5"></i></button>
                    <button onmousedown="event.preventDefault()" onclick="toggleVoiceInput()" id="mic-btn" class="p-2.5 rounded-xl text-red-500 hover:bg-red-50"><i data-lucide="mic" class="w-5 h-5"></i></button>
                    <button onmousedown="event.preventDefault()" onclick="toggleZenMode()" class="p-2.5 rounded-xl text-gray-500 hover:bg-gray-100"><i data-lucide="maximize-2" class="w-5 h-5"></i></button>
                    <button onclick="toggleMenu('ai-menu')" class="p-2.5 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- YÃœZEN SEÃ‡Ä°M MENÃœSÃœ -->
    <div id="floating-pill-menu" class="floating-pill hidden">
        <button onclick="openSubMenu('color-grid')" class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center border border-indigo-100"><i data-lucide="palette" class="w-5 h-5"></i></button>
        <button onclick="openSubMenu('magic-fix')" class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center border border-purple-100"><i data-lucide="wand-2" class="w-5 h-5"></i></button>
    </div>

    <!-- RENK MENÃœSÃœ -->
    <div id="color-grid" class="context-menu hidden p-4">
        <div class="flex gap-2 mb-3">
            <button id="highlight-toggle" onclick="toggleHighlightMode()" class="flex-1 py-2 bg-gray-900 text-white text-[10px] font-bold rounded-lg uppercase">YazÄ± Rengi</button>
            <button onclick="applyColor('remove')" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg" title="Rengi SÄ±fÄ±rla (Silgi)"><i data-lucide="eraser" class="w-4 h-4"></i></button>
        </div>
        <div id="color-palette-inner" class="grid grid-cols-6 gap-2 max-h-48 overflow-y-auto pr-1 custom-scroll"></div>
    </div>

    <!-- SÄ°HÄ°R MENÃœSÃœ -->
    <div id="magic-fix" class="context-menu hidden flex flex-col">
        <button onclick="magicAction('grammar')" class="p-3 text-left text-sm font-medium hover:bg-gray-50 border-b flex gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> DÃ¼zelt</button>
        <button onclick="magicAction('enrich')" class="p-3 text-left text-sm font-medium hover:bg-gray-50 border-b flex gap-2"><i data-lucide="sparkles" class="w-4 h-4 text-purple-500"></i> ZenginleÅŸtir</button>
        <button onclick="magicAction('formal')" class="p-3 text-left text-sm font-medium hover:bg-gray-50 border-b flex gap-2"><i data-lucide="briefcase" class="w-4 h-4 text-blue-500"></i> ResmileÅŸtir</button>
        <button onclick="magicAction('translate')" class="p-3 text-left text-sm font-medium hover:bg-gray-50 flex gap-2"><i data-lucide="languages" class="w-4 h-4 text-orange-500"></i> Ä°ngilizce Yap</button>
    </div>

    <!-- FONT MENÃœSÃœ -->
    <div id="font-menu" class="context-menu hidden flex flex-col shadow-2xl">
        <div class="p-2 text-[10px] font-bold text-gray-400 bg-gray-50 uppercase tracking-widest sticky top-0">YazÄ± Tipleri</div>
        <button onclick="updateFont('font-hand')" class="p-3 text-left font-hand border-b hover:bg-gray-50 text-lg">El YazÄ±sÄ± (Kalam)</button>
        <button onclick="updateFont('font-serif')" class="p-3 text-left font-serif border-b hover:bg-gray-50">Kitap Kurdu (Serif)</button>
        <button onclick="updateFont('font-roboto')" class="p-3 text-left font-roboto border-b hover:bg-gray-50">Daktilo (Mono)</button>
        <button onclick="updateFont('font-comfortaa')" class="p-3 text-left font-comfortaa border-b hover:bg-gray-50">Modern</button>
        <button onclick="updateFont('font-pacifico')" class="p-3 text-left font-pacifico hover:bg-gray-50">Retro</button>
    </div>

    <!-- AI ANA MENÃœSÃœ (HEPSÄ° BURADA) -->
    <div id="ai-menu" class="context-menu hidden flex flex-col shadow-2xl">
        <div class="sticky top-0 bg-white/95 backdrop-blur z-10 border-b">
             <div class="p-2 text-[10px] font-bold text-gray-400 bg-gray-50 uppercase tracking-widest">Ã–zel EÄŸitim & Okul</div>
        </div>
        <button onclick="runAI('lesson_plan_udl')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="graduation-cap" class="w-4 h-4 text-indigo-500"></i> UDL Ders PlanÄ±</button>
        <button onclick="runAI('iep_goals')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="target" class="w-4 h-4 text-green-500"></i> BEP Hedefleri</button>
        <button onclick="runAI('social_story')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="book-heart" class="w-4 h-4 text-pink-500"></i> Sosyal Ã–ykÃ¼</button>
        <button onclick="runAI('behavior_chart')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-red-500"></i> DavranÄ±ÅŸ Ã‡izelgesi</button>
        <button onclick="runAI('visual_text')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="eye" class="w-4 h-4 text-purple-500"></i> GÃ¶rselleÅŸtir (Easy Read)</button>
        <button onclick="runAI('adapt_activity')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="puzzle" class="w-4 h-4 text-orange-500"></i> Etkinlik Uyarla</button>
        <button onclick="runAI('parent_message')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="mail" class="w-4 h-4 text-blue-500"></i> Veli MesajÄ±</button>
        <button onclick="runAI('pedagogical_organizer')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="layout-template" class="w-4 h-4 text-teal-500"></i> Pedagojik Ã–rgÃ¼tleyici</button>
        <button onclick="runAI('fill_blanks')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="edit-3" class="w-4 h-4 text-indigo-600"></i> BoÅŸluk Doldurma</button>
        <button onclick="runAI('debate')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-indigo-600"></i> MÃ¼nazara Konusu</button>
        <button onclick="runAI('quiz')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="help-circle" class="w-4 h-4"></i> SÄ±nav HazÄ±rla</button>
        
        <!-- YENÄ° EKLENEN Ã–ZELLÄ°KLER (Ã–ZEL EÄžÄ°TÄ°M) -->
        <button onclick="runAI('parent_report')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="clipboard-list" class="w-4 h-4 text-teal-600"></i> Profesyonel Veli Raporu</button>
        <button onclick="runAI('material_ideas')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="box" class="w-4 h-4 text-amber-500"></i> Materyal & Etkinlik Fikri</button>
        <button onclick="runAI('gamify_lesson')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="gamepad-2" class="w-4 h-4 text-rose-500"></i> Dersi OyunlaÅŸtÄ±r</button>
        <button onclick="runAI('emotion_regulation')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="heart-pulse" class="w-4 h-4 text-red-400"></i> Duygu RegÃ¼lasyon</button>

        <div class="sticky top-0 bg-white/95 backdrop-blur z-10 border-y mt-2">
            <div class="p-2 text-[10px] font-bold text-gray-400 bg-gray-50 uppercase tracking-widest">Analiz & Ã–zet</div>
        </div>
        <button onclick="runAI('mind_map')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="network" class="w-4 h-4 text-indigo-600"></i> KarÄ±ÅŸÄ±k Kavram HaritasÄ±</button>
        <button onclick="runAI('summarize_short')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="scissors" class="w-4 h-4 text-green-600"></i> Renkli KÄ±sa Ã–zet</button>
        <button onclick="runAI('summarize_long')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4 text-blue-600"></i> Renkli Uzun Ã–zet</button>
        <button onclick="runAI('swot')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="crosshair" class="w-4 h-4"></i> SWOT Analizi</button>
        <button onclick="runAI('socratic_questions')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="message-circle-question" class="w-4 h-4"></i> Sokratik Sorular</button>
        <button onclick="runAI('generate_rubric')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="table" class="w-4 h-4"></i> Rubrik</button>
        <button onclick="runAI('generate_analogy')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="lightbulb" class="w-4 h-4"></i> Analoji Kur</button>
        <button onclick="runAI('eli5')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="baby" class="w-4 h-4 text-orange-600"></i> BasitleÅŸtir (5 YaÅŸ)</button>
        <button onclick="runAI('key_points')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="list-checks" class="w-4 h-4 text-orange-600"></i> Kritik Maddeler</button>
        <button onclick="runAI('explain')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="help-circle" class="w-4 h-4 text-indigo-500"></i> Nedir? (AÃ§Ä±kla)</button>
        <button onclick="runAI('analyze_mood')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="smile" class="w-4 h-4"></i> Ruh Hali</button>
        
        <!-- YENÄ° EKLENEN Ã–ZELLÄ°KLER (ANALÄ°Z) -->
        <button onclick="runAI('action_items')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4 text-emerald-600"></i> Aksiyon Listesi (To-Do)</button>
        <button onclick="runAI('flashcards')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-orange-500"></i> Flashcard Ã‡alÄ±ÅŸma KartlarÄ±</button>

        <div class="sticky top-0 bg-white/95 backdrop-blur z-10 border-y mt-2">
            <div class="p-2 text-[10px] font-bold text-gray-400 bg-gray-50 uppercase tracking-widest">YaratÄ±cÄ± & Ä°ÅŸ</div>
        </div>
        <button onclick="runAI('podcast')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="mic-2" class="w-4 h-4 text-indigo-600"></i> Podcast Metni</button>
        <button onclick="runAI('devil_advocate')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4 text-red-600"></i> ÅžeytanÄ±n AvukatÄ±</button>
        <button onclick="runAI('scenario')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="drama" class="w-4 h-4 text-purple-600"></i> Senaryo/Diyalog</button>
        <button onclick="runAI('funny')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="smile-plus" class="w-4 h-4 text-orange-500"></i> Esprili Yap</button>
        <button onclick="runAI('blogify_short')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="pen-tool" class="w-4 h-4"></i> Blog YazÄ±sÄ±</button>
        <button onclick="runAI('thread')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="share-2" class="w-4 h-4"></i> Tweet Zinciri</button>
        <button onclick="runAI('bio_site')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="user-circle" class="w-4 h-4"></i> Bio Site</button>
        <button onclick="runAI('bio_short')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="twitter" class="w-4 h-4"></i> KÄ±sa Bio</button>
        <button onclick="runAI('bio_services')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="briefcase" class="w-4 h-4"></i> Hizmet Listesi</button>
        <button onclick="runAI('bio_slogan')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="megaphone" class="w-4 h-4"></i> Slogan</button>
        <button onclick="runAI('email_formal')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="mail-check" class="w-4 h-4"></i> Resmi E-Posta</button>
        <button onclick="runAI('generate_references')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4"></i> KaynakÃ§a</button>
        <button onclick="runAI('generate_hashtags')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="hash" class="w-4 h-4"></i> Hashtag</button>
        <button onclick="runAI('seo_analysis')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="search-check" class="w-4 h-4"></i> SEO</button>
        <button onclick="runAI('image_prompts')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="image" class="w-4 h-4"></i> GÃ¶rsel Promptu</button>
        <button onclick="runAI('extract_tasks')" class="p-3 text-left text-sm hover:bg-indigo-50 border-b flex items-center gap-2"><i data-lucide="list-todo" class="w-4 h-4"></i> GÃ¶rev Ã‡Ä±kar</button>
        
        <button onclick="runAI('whatsapp_status')" class="p-4 text-left text-sm bg-green-50 hover:bg-green-100 text-green-700 font-bold flex items-center gap-2 sticky bottom-0 border-t border-green-200"><i data-lucide="smartphone" class="w-4 h-4"></i> WhatsApp Modu</button>
    </div>

    <!-- WHATSAPP & YOUTUBE MODALS (AynÄ±) -->
    <div id="wp-modal" class="fixed inset-0 hidden z-[200] bg-black/95 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white rounded-[40px] overflow-hidden flex flex-col h-[70vh] shadow-2xl">
            <div id="wp-preview" class="flex-1 bg-[#25D366] flex flex-col items-center justify-center p-8 text-center text-white relative transition-colors duration-500">
                <div id="wp-text" class="text-2xl font-hand leading-snug break-words w-full max-h-full overflow-y-auto"></div>
                <div class="absolute bottom-4 text-xs font-mono opacity-60">BarÄ±ÅŸ'Ä±n Notu</div>
            </div>
            <div class="p-6 bg-white flex flex-col gap-3">
                <div class="flex justify-center gap-2 mb-2">
                    <button onclick="setWpBg('#25D366')" class="w-8 h-8 rounded-full bg-[#25D366] border-2 border-gray-100"></button>
                    <button onclick="setWpBg('#FF5252')" class="w-8 h-8 rounded-full bg-[#FF5252] border-2 border-gray-100"></button>
                    <button onclick="setWpBg('#3b82f6')" class="w-8 h-8 rounded-full bg-[#3b82f6] border-2 border-gray-100"></button>
                    <button onclick="setWpBg('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-gray-100"></button>
                </div>
                <button onclick="saveWpToNote()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold">Not Olarak Kaydet</button>
                <button onclick="closeWpMode()" class="w-full py-2 text-gray-400 font-bold text-xs uppercase">Kapat</button>
            </div>
        </div>
    </div>

    <div id="yt-modal" class="fixed inset-0 hidden z-[150] bg-black/60 backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-lg rounded-[32px] p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2 text-red-600"><i data-lucide="youtube"></i> YouTube AsistanÄ±</h3>
                <button onclick="closeYouTubeMode()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="bg-red-50 p-4 rounded-2xl border border-red-100 mb-4">
                <p class="text-xs text-red-800 font-bold mb-2">1. ADIM: Video linkini kopyalayÄ±p metni al:</p>
                <div class="flex gap-2">
                    <button onclick="window.open('https://youtubetranscript.com/', '_blank')" class="flex-1 py-2 bg-white text-red-600 border border-red-200 rounded-lg text-xs font-bold hover:bg-red-600 hover:text-white transition-colors">Sunucu 1</button>
                    <button onclick="window.open('https://downsub.com/', '_blank')" class="flex-1 py-2 bg-white text-red-600 border border-red-200 rounded-lg text-xs font-bold hover:bg-red-600 hover:text-white transition-colors">Sunucu 2</button>
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-2 font-bold">2. ADIM: AldÄ±ÄŸÄ±n metni buraya yapÄ±ÅŸtÄ±r:</p>
            <textarea id="yt-transcript" class="w-full h-40 border border-gray-100 bg-gray-50 rounded-2xl p-4 text-sm focus:ring-2 focus:ring-red-100 outline-none resize-none mb-4" placeholder="Metni buraya yapÄ±ÅŸtÄ±r..."></textarea>
            <button onclick="processYouTubeTranscript()" class="w-full py-4 bg-red-600 text-white rounded-2xl font-bold shadow-lg shadow-red-200 flex items-center justify-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> BarÄ±ÅŸÃ§a Ã–zetle</button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 hidden z-[200] bg-black/60 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i data-lucide="settings"></i> Ayarlar</h3>
            <div class="mb-4">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Gemini API Key</label>
                <input type="password" id="api-key-input" class="w-full border p-3 rounded-xl bg-gray-50 focus:ring-2 ring-indigo-100 outline-none">
            </div>
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Yapay Zeka Modeli</label>
                <input type="text" id="api-model-input" class="w-full border p-3 rounded-xl bg-gray-50 focus:ring-2 ring-indigo-100 outline-none" placeholder="gemini-2.5-flash-preview-09-2025">
            </div>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="manualBackup()" class="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex flex-col items-center gap-2"><i data-lucide="download" class="text-green-600"></i><span class="text-[10px] font-bold">Yedek Ä°ndir</span></button>
                <button onclick="triggerImport()" class="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex flex-col items-center gap-2"><i data-lucide="upload" class="text-blue-600"></i><span class="text-[10px] font-bold">Geri YÃ¼kle</span></button>
                <button onclick="migrateOldData(true)" class="col-span-2 p-3 bg-indigo-50 text-indigo-700 rounded-xl border border-indigo-100 text-xs font-bold">Eski NotlarÄ± Tara & Kurtar</button>
            </div>
            <button onclick="saveSettings()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold">Kaydet</button>
            <button onclick="toggleSettings()" class="w-full py-3 mt-2 text-gray-400 text-xs font-bold">VazgeÃ§</button>
            <input type="file" id="import-file" class="hidden" onchange="handleImport(this)">
        </div>
    </div>

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[9999] pointer-events-none flex flex-col gap-2"></div>

    <script>
        const STORAGE_KEY = 'baris_ultimate_v107';
        const CATEGORIES = {
            tarih: 'Tarih', dini: 'Dini', siyasi: 'Siyasi', 
            egitim: 'EÄŸitim', guncel: 'GÃ¼ncel', is: 'Ä°ÅŸ', 
            kisisel: 'KiÅŸisel', diger: 'DiÄŸer'
        };
        const COLORS = ['#000000','#374151','#dc2626','#ef4444','#ea580c','#f97316','#ca8a04','#eab308','#16a34a','#22c55e','#0d9488','#14b8a6','#2563eb','#3b82f6','#4f46e5','#6366f1','#7c3aed','#8b5cf6','#9333ea','#db2777','#e11d48','#f43f5e','#4b5563','#9ca3af'];

        const LEGACY_KEYS = ['baris_ultimate_v106','baris_ultimate_v105','baris_ultimate_v104','baris_ultimate_v103','baris_ultimate_v102','baris_ultimate_v101','baris_ultimate_v100','baris_final_notes_v35','baris_universal_db_v1','baris_final_notes_v34','baris_final_notes_v33','baris_final_notes_v32','baris_final_notes_v31','baris_final_notes_v30','baris_final_notes_v29_special_ed'];

        let notes = [], currentFilter = 'all', activeNoteId = null, isListening = false, recognition = null, isHighlightMode = false, selectedCategory = 'guncel', selectedFont = 'font-hand';
        let lastChosenColor = ''; 

        window.onload = () => {
            migrateOldData(); loadNotes(); initVoice(); renderColorGrid();
            if(window.lucide) lucide.createIcons();
            document.addEventListener('selectionchange', checkSelection);
            
            const key = localStorage.getItem('gemini_api_key');
            if(key) document.getElementById('api-key-input').value = key;
            const savedModel = localStorage.getItem('gemini_api_model');
            if(savedModel) document.getElementById('api-model-input').value = savedModel;
            else document.getElementById('api-model-input').value = 'gemini-2.5-flash-preview-09-2025';

            const editor = document.getElementById('note-content');
            editor.oninput = () => {
                const count = editor.innerText.trim().split(/\s+/).filter(x => x.length > 0).length;
                document.getElementById('word-count').innerText = `${count} Kelime`;
            };
        };

        function migrateOldData(force = false) {
            let migrated = [], foundCount = 0;
            const currentIds = new Set(notes.map(n => n.id));
            LEGACY_KEYS.forEach(key => {
                try {
                    const raw = localStorage.getItem(key);
                    if(raw) {
                        const data = JSON.parse(raw);
                        if(Array.isArray(data)) {
                            data.forEach(item => { if(!currentIds.has(item.id)) { migrated.push(item); currentIds.add(item.id); foundCount++; } });
                        }
                    }
                } catch(e){}
            });
            if(migrated.length > 0) { notes = [...notes, ...migrated]; notes = Array.from(new Map(notes.map(item => [item.id, item])).values()); saveNotes(); showToast(`${foundCount} eski not kurtarÄ±ldÄ±! âœ¨`, "success"); } 
            else if (force) showToast("KurtarÄ±lacak yeni not bulunamadÄ±.", "success");
        }

        function loadNotes() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if(raw) { try { notes = JSON.parse(raw); } catch(e) { notes = []; } } else { notes = []; }
            renderNotes();
        }
        function saveNotes() { localStorage.setItem(STORAGE_KEY, JSON.stringify(notes)); renderNotes(); }

        function renderNotes() {
            const grid = document.getElementById('notes-grid');
            const empty = document.getElementById('empty-state');
            const search = document.getElementById('searchInput').value.toLowerCase();
            grid.innerHTML = '';
            
            const filtered = notes.filter(n => {
                const matchFilter = currentFilter === 'all' || n.category === currentFilter;
                const matchSearch = (n.title + n.content).toLowerCase().includes(search);
                return matchFilter && matchSearch;
            }).sort((a,b) => b.updatedAt - a.updatedAt);

            if(filtered.length === 0) empty.classList.remove('hidden'); else empty.classList.add('hidden');

            filtered.forEach(n => {
                const date = new Date(n.updatedAt).toLocaleDateString('tr-TR', { day:'numeric', month:'short' });
                const card = document.createElement('div');
                const catKey = n.category || 'diger';
                card.className = `note-card animate-fade-in cat-border-${catKey}`;
                card.onclick = () => openNoteEditor(n.id);
                card.innerHTML = `
                    <div class="p-6 h-full flex flex-col">
                        <h3 class="font-bold text-lg mb-2 line-clamp-2 text-gray-800">${n.title || 'BaÅŸlÄ±ksÄ±z'}</h3>
                        <div class="flex-1 text-sm text-gray-500 overflow-hidden ${n.font} line-clamp-4 leading-relaxed">${n.content}</div>
                        <div class="mt-4 pt-3 border-t border-gray-50 flex justify-between items-end">
                            <span class="text-[10px] font-bold uppercase px-2 py-1 rounded border theme-${catKey}">${CATEGORIES[catKey]}</span>
                            <span class="text-[10px] text-gray-300 font-medium">${date}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            if(window.lucide) lucide.createIcons();
        }

        function openNoteEditor(id = null) {
            activeNoteId = id;
            const modal = document.getElementById('note-modal');
            const panel = document.getElementById('modal-panel');
            const delBtn = document.getElementById('btn-delete-note');
            if(id) {
                const n = notes.find(x => x.id === id);
                document.getElementById('note-title').innerHTML = n.title;
                document.getElementById('note-content').innerHTML = n.content;
                selectedCategory = n.category;
                selectedFont = n.font || 'font-hand';
                delBtn.classList.remove('hidden');
            } else {
                document.getElementById('note-title').innerHTML = '';
                document.getElementById('note-content').innerHTML = '';
                selectedCategory = 'guncel';
                selectedFont = 'font-hand';
                delBtn.classList.add('hidden');
            }
            updateCategoryChips(); updateFont(selectedFont, false);
            modal.classList.remove('hidden');
            setTimeout(() => panel.classList.remove('translate-y-full'), 10);
        }

        function closeNoteEditor() {
            const panel = document.getElementById('modal-panel');
            panel.classList.add('translate-y-full');
            setTimeout(() => { document.getElementById('note-modal').classList.add('hidden'); closeAllMenus(); }, 400);
        }

        function saveCurrentNote() {
            const title = document.getElementById('note-title').innerHTML;
            const content = document.getElementById('note-content').innerHTML;
            const textOnly = document.getElementById('note-content').innerText.trim();
            if(!title && !textOnly) return showToast("BoÅŸ not kaydedilemez!", "error");
            const noteData = { id: activeNoteId || 'n_' + Date.now(), title: title, content: content, category: selectedCategory, font: selectedFont, updatedAt: Date.now() };
            if(activeNoteId) { const idx = notes.findIndex(x => x.id === activeNoteId); notes[idx] = noteData; } else { notes.push(noteData); }
            saveNotes(); showToast("Kaydedildi âœ…", "success"); closeNoteEditor();
        }

        function deleteCurrentNote() {
            if(!activeNoteId) return;
            notes = notes.filter(x => x.id !== activeNoteId);
            saveNotes(); showToast("Not silindi ðŸ—‘ï¸", "success"); closeNoteEditor();
        }

        function updateCategoryChips() {
            const container = document.getElementById('editor-cat-chips');
            container.innerHTML = '';
            Object.keys(CATEGORIES).forEach(k => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded-full text-[10px] font-bold uppercase transition-all whitespace-nowrap border ${k === selectedCategory ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-400 border-gray-100'}`;
                btn.innerText = CATEGORIES[k];
                btn.onclick = () => { selectedCategory = k; updateCategoryChips(); };
                container.appendChild(btn);
            });
        }

        function filterNotes(cat) {
            currentFilter = cat;
            document.querySelectorAll('.cat-filter-btn').forEach(b => { b.classList.remove('bg-gray-800', 'text-white'); b.classList.add('bg-white', 'text-gray-400'); });
            event.target.classList.add('bg-gray-800', 'text-white');
            renderNotes();
        }

        function toggleMenu(id) {
            const el = document.getElementById(id);
            const isHidden = el.classList.contains('hidden');
            closeAllMenus();
            if(isHidden) el.classList.remove('hidden');
        }

        function closeAllMenus() {
            ['font-menu', 'ai-menu', 'color-grid', 'magic-fix', 'floating-pill-menu'].forEach(id => { document.getElementById(id)?.classList.add('hidden'); });
        }

        function updateFont(f, close = true) {
            selectedFont = f;
            const editor = document.getElementById('note-content');
            const fontClasses = ['font-hand', 'font-serif', 'font-mono', 'font-sans', 'font-caveat', 'font-lora', 'font-oswald', 'font-roboto', 'font-pacifico', 'font-comfortaa'];
            editor.classList.remove(...fontClasses); editor.classList.add(f);
            if(close) closeAllMenus();
        }

        function execAction(cmd) { document.execCommand(cmd, false, null); }

        function renderColorGrid() {
            const grid = document.getElementById('color-palette-inner');
            COLORS.forEach(c => {
                const b = document.createElement('button');
                b.className = "w-full aspect-square rounded-md shadow-sm border border-black/5 active:scale-90 transition-transform";
                b.style.backgroundColor = c;
                b.onmousedown = (e) => { e.preventDefault(); applyColor(c); };
                grid.appendChild(b);
            });
        }

        function toggleHighlightMode() {
            isHighlightMode = !isHighlightMode;
            const btn = document.getElementById('highlight-toggle');
            btn.innerText = isHighlightMode ? "Fosforlu Mod" : "YazÄ± Rengi";
            btn.className = isHighlightMode ? "w-full mb-3 py-2 bg-yellow-400 text-black text-[10px] font-bold rounded-lg uppercase" : "w-full mb-3 py-2 bg-gray-900 text-white text-[10px] font-bold rounded-lg uppercase";
        }

        function applyColor(c) {
            document.execCommand('styleWithCSS', false, true);
            const selection = window.getSelection();
            if (selection.isCollapsed) { const range = getWordAtCaret(); if(range) { selection.removeAllRanges(); selection.addRange(range); } }
            
            if (c === 'remove') {
                document.execCommand('removeFormat', false, null); 
                document.execCommand('foreColor', false, '#374151'); 
            } else {
                if(isHighlightMode) {
                    document.execCommand('hiliteColor', false, c);
                } else {
                    document.execCommand('foreColor', false, c);
                    lastChosenColor = c; 
                }
            }
            closeAllMenus();
        }

        function getWordAtCaret() {
            const sel = window.getSelection();
            if (sel.rangeCount === 0) return null;
            const range = sel.getRangeAt(0);
            if (!range.collapsed) return range;
            const node = range.startContainer;
            if (node.nodeType !== Node.TEXT_NODE) return null;
            const text = node.textContent;
            const offset = range.startOffset;
            let start = offset; while (start > 0 && /\S/.test(text[start - 1])) start--;
            let end = offset; while (end < text.length && /\S/.test(text[end])) end++;
            if (start === end) return null;
            const newRange = document.createRange(); newRange.setStart(node, start); newRange.setEnd(node, end);
            return newRange;
        }

        function checkSelection() {
            const sel = window.getSelection();
            const pill = document.getElementById('floating-pill-menu');
            const editorNode = document.getElementById('note-content');
            const titleNode = document.getElementById('note-title');

            if ((editorNode.contains(sel.anchorNode) || titleNode.contains(sel.anchorNode)) && !document.getElementById('ai-loading').classList.contains('flex')) {
                let rect;
                if (sel.toString().trim().length > 0) { rect = sel.getRangeAt(0).getBoundingClientRect(); } 
                else if(sel.isCollapsed) { const range = getWordAtCaret(); if(range) rect = range.getBoundingClientRect(); }

                if (rect) {
                    let top = rect.top - 50; let left = rect.left + (rect.width / 2);
                    if (top < 10) top = rect.bottom + 10; if (left < 50) left = 50; if (left > window.innerWidth - 50) left = window.innerWidth - 50;
                    pill.style.top = top + 'px'; pill.style.left = left + 'px'; pill.classList.remove('hidden'); return;
                }
            }
            if(!document.activeElement.closest('.context-menu') && !document.activeElement.closest('.floating-pill')) { pill.classList.add('hidden'); }
        }

        function openSubMenu(id) {
            const pill = document.getElementById('floating-pill-menu');
            const menu = document.getElementById(id);
            const pillRect = pill.getBoundingClientRect();
            let top = pillRect.top; let left = pillRect.left;
            if (top + 300 > window.innerHeight) top = window.innerHeight - 350;
            if (left + 250 > window.innerWidth) left = window.innerWidth - 260;
            menu.style.top = top + 'px'; menu.style.left = left + 'px';
            menu.classList.remove('hidden'); pill.classList.add('hidden');
        }

        function toggleZenMode() {
            const modal = document.getElementById('modal-panel');
            modal.classList.toggle('!inset-0'); modal.classList.toggle('!max-w-none'); modal.classList.toggle('!rounded-none');
            showToast("Zen Modu Aktif", "success");
        }
        function toggleReadMode() {
            const editor = document.getElementById('note-content');
            const isRead = editor.getAttribute('contenteditable') === 'false';
            editor.setAttribute('contenteditable', isRead ? 'true' : 'false');
            editor.classList.toggle('text-2xl'); editor.classList.toggle('max-w-3xl'); editor.classList.toggle('mx-auto');
            showToast(isRead ? "DÃ¼zenleme Modu" : "Okuma Modu", "success");
        }
        function toggleScreenshotMode() {
            const panel = document.getElementById('modal-panel');
            panel.classList.toggle('screenshot-mode');
            if(panel.classList.contains('screenshot-mode')) {
                showToast("FotoÄŸraf Modu: Ã‡Ä±kmak iÃ§in ekrana dokun.", "success");
                panel.onclick = (e) => { if(!e.target.closest('.hide-on-capture')) toggleScreenshotMode(); };
            } else { panel.onclick = null; }
        }

        function initVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR'; recognition.continuous = true; recognition.interimResults = true;
                recognition.onresult = (e) => {
                    let final = ''; for (let i = e.resultIndex; i < e.results.length; ++i) { if(e.results[i].isFinal) final += e.results[i][0].transcript; }
                    if(final) document.getElementById('note-content').innerHTML += ' ' + final;
                };
            }
        }
        function toggleVoiceInput() {
            if(!recognition) return showToast("Mikrofon desteklenmiyor.", "error");
            isListening = !isListening;
            const btn = document.getElementById('mic-btn');
            if(isListening) { recognition.start(); btn.classList.add('bg-red-500', 'text-white', 'animate-pulse'); showToast("Dinliyorum...", "success"); } 
            else { recognition.stop(); btn.classList.remove('bg-red-500', 'text-white', 'animate-pulse'); }
        }

        async function runAI(action, customText = null) {
            const editor = document.getElementById('note-content');
            const text = customText || editor.innerText;
            if(!text.trim() && action !== 'analyze_mood' && action !== 'generate_title') return showToast("Metin yok!", "error");
            
            const key = localStorage.getItem('gemini_api_key');
            const AI_MODEL = localStorage.getItem('gemini_api_model') || 'gemini-2.5-flash-preview-09-2025';
            
            if(!key) { toggleSettings(); return showToast("API AnahtarÄ± girin.", "error"); }
            closeAllMenus();
            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('ai-loading').classList.add('flex');
            
            let persona = "SÄ°STEM TALÄ°MATI: Sen bir asistan veya yapay zeka deÄŸilsin. Asla 'Merhaba', 'Ä°ÅŸte metin', 'Ä°stediÄŸin Ã¶zet', 'AÅŸaÄŸÄ±da bulabilirsin' gibi cÃ¼mleler kurma! SADECE istenilen sonucu ver. Metni yazanÄ±n (BarÄ±ÅŸ'Ä±n) kendi kaleminden Ã§Ä±kmÄ±ÅŸ gibi, sanki o not alÄ±yormuÅŸ gibi birinci ÅŸahÄ±s kullanarak (ben/biz) ve doÄŸrudan konuya girerek yaz. TÃ¼m yazÄ±m hatalarÄ±nÄ± dÃ¼zelt. Ã‡Ä±ktÄ±yÄ± doÄŸrudan HTML formatÄ±nda (sadece tagler ile) ver. Markdown (kod bloÄŸu) kullanma.\n\nÄ°ÅŸlenecek Metin: \"" + text + "\"\n\nGÃ¶rev: ";
            
            const preferredColor = lastChosenColor || '#2563eb'; 
            const highlighter = `Ã–nemli yerleri, kilit kelimeleri SADECE dÃ¼z metin olarak bÄ±rakma. Åžunlar gibi HTML etiketleriyle bolca vurgula: <span style='color: ${preferredColor}; font-weight: 800;'>Renkli</span>, <span class='highlight-marker'>Fosforlu</span>, <span style='color: #ef4444; font-weight: bold;'>KÄ±rmÄ±zÄ± Vurgu</span>. Ã‡Ä±ktÄ±n renkli ve canlÄ± olsun. `;

            const prompts = {
                generate_title: `Bu metni analiz et ve en uygun, kÄ±sa baÅŸlÄ±ÄŸÄ± yaz. TÄ±rnak kullanma.`,
                analyze_mood: "Duyguyu analiz et, tek bir emoji ver.",
                summarize_short: `${highlighter} Bu metnin yazÄ±m hatalarÄ±nÄ± dÃ¼zeltip, en vurucu yerlerini Ã§ok renkli, estetik ve aÅŸÄ±rÄ± kÄ±sa bir (TL;DR) Ã¶zet haline getir. Asla giriÅŸ/Ã§Ä±kÄ±ÅŸ cÃ¼mlesi kurma, doÄŸrudan notun kendisini BarÄ±ÅŸ'Ä±n aÄŸzÄ±ndan Ã§Ä±kmÄ±ÅŸ gibi dÃ¼zeltip yaz. Konuyu en iyi ÅŸekilde ifade et.`,
                summarize_long: `${highlighter} Bu metni detaylÄ±, madde madde Ã¶zetle. Renkli vurgular kullan. BarÄ±ÅŸ'Ä±n aÄŸzÄ±ndan yaz.`,
                fill_blanks: `Bu metindeki Ã¶nemli kelimeleri Ã§Ä±kararak Ã¶ÄŸrenciler iÃ§in bir "BoÅŸluk Doldurma" sÄ±navÄ± hazÄ±rla. Cevap anahtarÄ±nÄ± sona ekle. HTML.`,
                debate: `SÄ±nÄ±fta tartÄ±ÅŸÄ±labilecek 3 farklÄ± mÃ¼nazara konusu (Tez vs Antitez) Ã§Ä±kar. HTML.`,
                mind_map: `Bu konuyu detaylÄ±, hiyerarÅŸik bir 'Kavram HaritasÄ±' olarak yapÄ±landÄ±r. HTML iÃ§ iÃ§e listeler (<ul>, <li>) ve ok iÅŸaretleri (â†’) kullanarak gÃ¶rselleÅŸtir.`,
                pedagogical_organizer: `Ã–ÄŸretmek iÃ§in en uygun Grafik Ã–rgÃ¼tleyiciyi seÃ§ ve HTML tablosu ile oluÅŸtur.`,
                lesson_plan_udl: `UDL ilkelerine uygun ders planÄ± hazÄ±rla. HTML.`,
                iep_goals: `Ã–ÄŸrenci iÃ§in 3 adet SMART BEP hedefi yaz. HTML.`,
                social_story: `Carol Gray formatÄ±nda kÄ±sa Sosyal Ã–ykÃ¼ yaz. HTML.`,
                behavior_chart: `HaftalÄ±k DavranÄ±ÅŸ Ã‡izelgesi hazÄ±rla (HTML Tablo).`,
                visual_text: `Zihinsel yetersizliÄŸi olanlar iÃ§in 'Kolay Okunur' formatÄ±na Ã§evir, emoji kullan. HTML.`,
                adapt_activity: `EtkinliÄŸi Ã¶zel gereksinimli Ã¶ÄŸrenci iÃ§in uyarla (Ä°nklÃ¼zyon). HTML.`,
                podcast: `Ä°ki sunucunun konuÅŸtuÄŸu keyifli bir Podcast metnine dÃ¶nÃ¼ÅŸtÃ¼r. HTML Diyalog.`,
                devil_advocate: `Fikrin eksiklerini ve risklerini 'ÅžeytanÄ±n AvukatÄ±' olarak sÄ±rala.`,
                key_points: `En kritik 'Eve GÃ¶tÃ¼rÃ¼lecek MesajlarÄ±' madde madde Ã§Ä±kar.`,
                parent_report: `Bu karalama notlarÄ±nÄ±, veli toplantÄ±sÄ± iÃ§in profesyonel, yapÄ±cÄ± ve empatik bir 'Veli DeÄŸerlendirme Raporu'na dÃ¶nÃ¼ÅŸtÃ¼r. GeliÅŸim alanlarÄ±nÄ± vurgula. HTML.`,
                generate_quiz: `Ã–ÄŸrenciler iÃ§in 5 soruluk, renkli bir 'Ã‡oktan SeÃ§meli Test' hazÄ±rla. (A, B, C, D). Cevap anahtarÄ± ekle. HTML.`,
                material_ideas: `Bu konuyu Ã¶ÄŸretmek iÃ§in kullanÄ±labilecek somut ve gÃ¶rsel 'EÄŸitim Materyali Ã–nerileri' sun. HTML liste.`,
                action_items: `Bu metindeki/toplantÄ±daki kararlarÄ± 'Aksiyon Maddeleri (To-Do List)' olarak Ã§Ä±kar. Onay kutularÄ± (âœ…) kullan. HTML.`,
                gamify_lesson: `Bu konuyu sÄ±nÄ±fta Ã§ocuklarla oynanabilecek hareketli ve eÄŸlenceli bir sÄ±nÄ±f oyununa dÃ¶nÃ¼ÅŸtÃ¼r. KurallarÄ± HTML listesiyle anlat.`,
                emotion_regulation: `Duygu regÃ¼lasyonunu saÄŸlamasÄ±na yardÄ±mcÄ± olacak adÄ±m adÄ±m sakinleÅŸtirici bir rutin veya sosyal Ã¶ykÃ¼ oluÅŸtur.`,
                flashcards: `Bu metindeki en Ã¶nemli kavramlarÄ± 'Ã–nlÃ¼ ArkalÄ± Ã‡alÄ±ÅŸma KartlarÄ±' formatÄ±nda belirgin renkli arka planlÄ± HTML kutucuklarÄ± (div) olarak tasarla.`
            };

            const finalPrompt = persona + (prompts[action] || text);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL}:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
                });
                const data = await response.json();
                const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(result) {
                    const clean = result.replace(/^```html\s*/i, '').replace(/```$/, '').trim();
                    if(action === 'generate_title') { 
                        const titleHtml = lastChosenColor ? `<span style="color: ${lastChosenColor}">${clean}</span>` : clean;
                        document.getElementById('note-title').innerHTML = titleHtml; 
                        showToast("BaÅŸlÄ±k oluÅŸturuldu!", "success"); 
                    }
                    else if(action === 'analyze_mood') { document.getElementById('note-title').innerHTML = clean + " " + document.getElementById('note-title').innerHTML; }
                    else if(action === 'whatsapp_status') { document.getElementById('wp-text').innerHTML = clean; document.getElementById('wp-modal').classList.remove('hidden'); }
                    else { editor.innerHTML += `<br><br><div class='bg-indigo-50/30 p-4 rounded-2xl border border-indigo-100 mt-4 shadow-sm'>${clean}</div>`; showToast("TamamlandÄ± âœ¨", "success"); }
                }
            } catch(e) { showToast("AI HatasÄ±!", "error"); }
            finally { document.getElementById('ai-loading').classList.add('hidden'); document.getElementById('ai-loading').classList.remove('flex'); }
        }

        async function magicAction(type) {
            const sel = window.getSelection().toString();
            if(!sel) return showToast("Metin seÃ§melisin!", "error");
            
            const key = localStorage.getItem('gemini_api_key');
            const AI_MODEL = localStorage.getItem('gemini_api_model') || 'gemini-2.5-flash-preview-09-2025';

            let p = `SÄ°STEM TALÄ°MATI: Asla "Merhaba", "Ä°ÅŸte" gibi konuÅŸmalar yapma. SADECE sonucu ver. BarÄ±ÅŸ'Ä±n kendi kaleminden Ã§Ä±kmÄ±ÅŸ gibi doÄŸrudan metni yaz. Bu metni ${type === 'grammar' ? 'yazÄ±m ve imlaya gÃ¶re dÃ¼zelt' : type === 'enrich' ? 'estetik kelimelerle zenginleÅŸtir' : 'resmileÅŸtir'}: "${sel}"`;
            if(type === 'translate') p = `SÄ°STEM TALÄ°MATI: Asla sohbet etme. SADECE sonucu ver. Bu metni mÃ¼kemmel bir Ä°ngilizceye Ã§evir: "${sel}"`;
            
            document.getElementById('ai-loading').classList.remove('hidden'); document.getElementById('ai-loading').classList.add('flex');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL}:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] })
                });
                const data = await res.json();
                const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(result) document.execCommand('insertText', false, result.replace(/^```html\s*/i, '').replace(/```$/, '').trim());
            } catch(e){} finally { document.getElementById('ai-loading').classList.add('hidden'); document.getElementById('ai-loading').classList.remove('flex'); closeAllMenus(); }
        }

        function openYouTubeMode() { document.getElementById('yt-modal').classList.remove('hidden'); }
        function closeYouTubeMode() { document.getElementById('yt-modal').classList.add('hidden'); }
        async function processYouTubeTranscript() {
            const t = document.getElementById('yt-transcript').value;
            if(!t) return showToast("Metni yapÄ±ÅŸtÄ±rmadÄ±n!", "error");
            closeYouTubeMode(); openNoteEditor();
            document.getElementById('note-content').innerHTML = "YouTube Videosu Analiz Ediliyor...<br><br>" + t.substring(0,200) + "...";
            await runAI('summarize_long', t);
        }

        function setWpBg(c) { document.getElementById('wp-preview').style.backgroundColor = c; }
        function closeWpMode() { document.getElementById('wp-modal').classList.add('hidden'); }
        function saveWpToNote() {
            const txt = document.getElementById('wp-text').innerHTML;
            activeNoteId = null;
            document.getElementById('note-title').innerHTML = "WhatsApp Durumu - " + new Date().toLocaleDateString();
            document.getElementById('note-content').innerHTML = txt;
            selectedCategory = 'diger';
            saveCurrentNote(); closeWpMode();
        }

        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function saveSettings() { 
            localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value); 
            localStorage.setItem('gemini_api_model', document.getElementById('api-model-input').value); 
            showToast("Ayarlar Kaydedildi âœ…", "success"); 
            toggleSettings(); 
        }
        function manualBackup() {
            const data = localStorage.getItem(STORAGE_KEY);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `baris_not_yedek_${Date.now()}.json`; a.click();
        }
        function triggerImport() { document.getElementById('import-file').click(); }
        function handleImport(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); loadNotes(); showToast("Geri YÃ¼klendi!", "success"); }
                } catch(e){ showToast("HatalÄ± Dosya!", "error"); }
            }; reader.readAsText(input.files[0]);
        }
        function showToast(msg, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-2xl shadow-xl text-white text-xs font-bold animate-fade-in ${type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            toast.innerText = msg; container.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }
        
        function copyAllNotes() { 
            const data = localStorage.getItem(STORAGE_KEY);
            if(!data) return showToast("Kopyalanacak not yok!", "error");
            const tempInput = document.createElement("textarea");
            tempInput.value = data;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            showToast("KopyalandÄ±!", "success"); 
        }

        async function playTTS() {
            const editor = document.getElementById('note-content');
            const selection = window.getSelection().toString();
            const text = selection || editor.innerText;
            
            if (!text.trim()) return showToast("Seslendirilecek metin yok!", "error");

            const key = localStorage.getItem('gemini_api_key');
            if(!key) { toggleSettings(); return showToast("API AnahtarÄ± girin.", "error"); }

            const btn = document.getElementById('tts-btn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<div class="loader" style="width:20px;height:20px;border-width:2px;border-top-color:#3b82f6;"></div>';

            try {
                const safeText = text.substring(0, 800);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Ã‡ok neÅŸeli ve enerjik bir Ã¶ÄŸretmen tonuyla oku: " + safeText }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                        }
                    })
                });

                if(!response.ok) throw new Error("API YanÄ±t HatasÄ±");
                
                const data = await response.json();
                const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                if (base64Audio) {
                    const pcmData = Uint8Array.from(atob(base64Audio), c => c.charCodeAt(0));
                    const wavBlob = pcmToWav(pcmData.buffer, 24000); 
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    showToast("Seslendirme BaÅŸladÄ± ðŸŽ§", "success");
                } else {
                    throw new Error("Ses alÄ±namadÄ±");
                }
            } catch(e) {
                console.error(e);
                showToast("Seslendirme baÅŸarÄ±sÄ±z!", "error");
            } finally {
                btn.innerHTML = originalIcon;
            }
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            new Uint8Array(buffer, 44).set(new Uint8Array(pcmData));
            return new Blob([buffer], { type: 'audio/wav' });
        }
    </script>
</body>
</html>
