<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barış'ın Akıllı Not Defteri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter (Arayüz), Caveat (El Yazısı), Kalam (Post-it) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Caveat:wght@500;600;700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "demo", projectId: "demo" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let unsubscribeNotes = null;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth Error:", error); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) initNotesListener(user.uid);
        });

        function initNotesListener(userId) {
            if (unsubscribeNotes) unsubscribeNotes();
            const notesRef = collection(db, 'artifacts', appId, 'users', userId, 'notes');
            unsubscribeNotes = onSnapshot(notesRef, (snapshot) => {
                const notes = [];
                snapshot.forEach((doc) => notes.push({ id: doc.id, ...doc.data() }));
                notes.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                window.renderNotes(notes);
            });
        }

        window.addNoteToDb = async (data) => { if (currentUser) await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes'), { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); };
        window.deleteNoteFromDb = async (id) => { if (currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id)); };
        window.updateNoteInDb = async (id, data) => { if (currentUser) await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', id), { ...data, updatedAt: serverTimestamp() }); };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: 
                linear-gradient(rgba(229, 231, 235, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(229, 231, 235, 0.5) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* Post-it Stilleri - İki Tonlu */
        .post-it {
            font-family: 'Kalam', cursive;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .post-it:hover {
            transform: translateY(-5px) rotate(0deg) !important;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 10;
        }
        
        /* Bant Efekti */
        .tape-section {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 35px;
            background-color: rgba(255, 255, 255, 0.3);
            border-left: 1px dashed rgba(0,0,0,0.1);
            border-right: 1px dashed rgba(0,0,0,0.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            opacity: 0.6;
            z-index: 5;
            pointer-events: none;
        }

        /* Yeni Renk Paleti - Canlı ve Okunabilir */
        /* Header (Koyu) ve Body (Açık) */
        
        /* Tarih: Kiremit Kırmızısı */
        .theme-tarih .card-header { background: #fca5a5; color: #7f1d1d; }
        .theme-tarih .card-body { background: #fef2f2; color: #450a0a; }
        .btn-theme-tarih { background: #fef2f2; color: #b91c1c; border-color: #fca5a5; }
        .btn-theme-tarih.active { background: #ef4444; color: white; border-color: #ef4444; }

        /* Dini: Zümrüt Yeşili */
        .theme-dini .card-header { background: #86efac; color: #14532d; }
        .theme-dini .card-body { background: #f0fdf4; color: #14532d; }
        .btn-theme-dini { background: #f0fdf4; color: #15803d; border-color: #86efac; }
        .btn-theme-dini.active { background: #22c55e; color: white; border-color: #22c55e; }

        /* Siyasi: Kraliyet Mavisi */
        .theme-siyasi .card-header { background: #93c5fd; color: #1e3a8a; }
        .theme-siyasi .card-body { background: #eff6ff; color: #172554; }
        .btn-theme-siyasi { background: #eff6ff; color: #1d4ed8; border-color: #93c5fd; }
        .btn-theme-siyasi.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* Eğitim: Turuncu/Sarı */
        .theme-egitim .card-header { background: #fcd34d; color: #78350f; }
        .theme-egitim .card-body { background: #fffbeb; color: #451a03; }
        .btn-theme-egitim { background: #fffbeb; color: #b45309; border-color: #fcd34d; }
        .btn-theme-egitim.active { background: #f59e0b; color: white; border-color: #f59e0b; }

        /* Güncel: Camgöbeği */
        .theme-guncel .card-header { background: #67e8f9; color: #164e63; }
        .theme-guncel .card-body { background: #ecfeff; color: #083344; }
        .btn-theme-guncel { background: #ecfeff; color: #0e7490; border-color: #67e8f9; }
        .btn-theme-guncel.active { background: #06b6d4; color: white; border-color: #06b6d4; }

        /* Kişisel: Mor/Pembe */
        .theme-kisisel .card-header { background: #f0abfc; color: #701a75; }
        .theme-kisisel .card-body { background: #fdf4ff; color: #4a044e; }
        .btn-theme-kisisel { background: #fdf4ff; color: #a21caf; border-color: #f0abfc; }
        .btn-theme-kisisel.active { background: #d946ef; color: white; border-color: #d946ef; }

        /* İş: Gri/Indigo */
        .theme-is .card-header { background: #cbd5e1; color: #334155; }
        .theme-is .card-body { background: #f8fafc; color: #0f172a; }
        .btn-theme-is { background: #f8fafc; color: #475569; border-color: #cbd5e1; }
        .btn-theme-is.active { background: #64748b; color: white; border-color: #64748b; }

        /* Diğer: Nötr */
        .theme-diger .card-header { background: #d6d3d1; color: #44403c; }
        .theme-diger .card-body { background: #fafaf9; color: #292524; }
        .btn-theme-diger { background: #fafaf9; color: #57534e; border-color: #d6d3d1; }
        .btn-theme-diger.active { background: #78716c; color: white; border-color: #78716c; }

        /* Gizli Mod (Stealth Mode) */
        body.stealth-mode {
            background: #000 !important;
            background-image: none !important;
            overflow: hidden;
        }
        body.stealth-mode header, 
        body.stealth-mode #notes-grid,
        body.stealth-mode .filter-bar {
            opacity: 0;
            pointer-events: none;
        }
        body.stealth-mode #stealth-overlay {
            display: flex;
        }

        /* Animasyonlar */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .mic-active { animation: pulse-red 2s infinite; background-color: #fee2e2 !important; color: #ef4444 !important; border-color: #ef4444 !important; }

        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-sm z-20 flex-none border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-600 text-white p-2 rounded-lg shadow-md transform -rotate-3 hover:rotate-0 transition-transform">
                    <i data-lucide="notebook-pen" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-caveat font-bold text-gray-800 leading-none tracking-wide">Barış'ın Akıllı Not Defteri</h1>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <!-- Ayarlar Butonu -->
                <button onclick="toggleSettingsModal()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-indigo-600 transition-colors" title="Ayarlar & API Anahtarı">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>

                <!-- Gizli Kayıt Butonu -->
                <button onclick="toggleStealthMode()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-900 transition-colors" title="Gizli Mod">
                    <i data-lucide="eye-off" class="w-5 h-5"></i>
                </button>

                <button onclick="toggleNewNoteModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full shadow-lg transition transform active:scale-95 flex items-center space-x-2 text-sm font-medium">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Not Ekle</span>
                </button>
            </div>
        </div>

        <!-- Renkli Filter Bar -->
        <div class="filter-bar overflow-x-auto pb-3 pt-2 px-4">
            <div class="max-w-7xl mx-auto flex space-x-2 no-scrollbar">
                <button onclick="filterNotes('all')" class="filter-btn active bg-gray-800 text-white border-gray-800 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap shadow-sm border transition-all">Tümü</button>
                <button onclick="filterNotes('tarih')" class="filter-btn btn-theme-tarih px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Tarih</button>
                <button onclick="filterNotes('dini')" class="filter-btn btn-theme-dini px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Dini</button>
                <button onclick="filterNotes('siyasi')" class="filter-btn btn-theme-siyasi px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Siyasi</button>
                <button onclick="filterNotes('egitim')" class="filter-btn btn-theme-egitim px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Eğitim</button>
                <button onclick="filterNotes('guncel')" class="filter-btn btn-theme-guncel px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Güncel</button>
                <button onclick="filterNotes('is')" class="filter-btn btn-theme-is px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">İş</button>
                <button onclick="filterNotes('kisisel')" class="filter-btn btn-theme-kisisel px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Kişisel</button>
                <button onclick="filterNotes('diger')" class="filter-btn btn-theme-diger px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap border-2 transition-all">Diğer</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6 relative" id="main-container">
        
        <!-- Arama -->
        <div class="max-w-xl mx-auto mb-8 relative group">
            <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5 group-hover:text-indigo-500 transition-colors"></i>
            <input type="text" id="searchInput" onkeyup="searchNotes()" placeholder="Renkli notlarımda ara..." class="w-full pl-12 pr-4 py-3 bg-white/80 backdrop-blur border-none rounded-2xl shadow-sm text-gray-700 focus:ring-2 focus:ring-indigo-300 transition-shadow">
        </div>

        <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-24 max-w-7xl mx-auto">
            <!-- Notlar buraya eklenecek -->
        </div>
    </main>

    <!-- Stealth Mode Overlay -->
    <div id="stealth-overlay" class="fixed inset-0 bg-black z-[100] hidden flex-col items-center justify-center text-gray-600 select-none">
        <div class="absolute top-10 w-full text-center">
            <p class="text-xs text-gray-800">Sistem Uyku Modu</p>
        </div>
        <button onclick="toggleStealthMode()" class="w-24 h-24 rounded-full bg-transparent border border-gray-900/30"></button>
        <div class="absolute bottom-10 w-full px-10">
            <div id="stealth-transcript" class="text-gray-900 text-xs font-mono h-20 overflow-hidden opacity-10"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity" onclick="toggleSettingsModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="settings" class="w-6 h-6 mr-2 text-indigo-600"></i>
                Ayarlar
            </h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Anahtarı</label>
                <input type="password" id="api-key-input" placeholder="AI-zaSy..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <p class="text-xs text-gray-500 mt-1">Anahtarınız sadece tarayıcınızda (localStorage) saklanır.</p>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="toggleSettingsModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">İptal</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Modal (Yeni Not) -->
    <div id="note-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:top-10 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-2xl bg-[#fff] rounded-t-3xl md:rounded-3xl shadow-2xl transform transition-transform duration-300 translate-y-full md:translate-y-0 flex flex-col max-h-[90vh]" id="modal-panel">
            
            <div class="p-6 flex-1 flex flex-col overflow-hidden">
                <input type="hidden" id="note-id">
                
                <!-- Başlık -->
                <input type="text" id="note-title" placeholder="Başlık..." class="text-2xl font-bold font-caveat text-gray-800 placeholder-gray-300 border-none focus:ring-0 p-0 bg-transparent mb-4">
                
                <!-- Kategori Seçici -->
                <div class="flex flex-wrap gap-2 mb-4" id="category-selector"></div>

                <!-- İçerik -->
                <div class="relative flex-1 bg-gray-50 rounded-xl p-4 border border-gray-100 group">
                    <textarea id="note-content" placeholder="Fikirlerinizi buraya yazın veya anlatın..." class="w-full h-full resize-none bg-transparent border-none focus:ring-0 p-0 text-lg font-kalam text-gray-700 leading-relaxed"></textarea>
                    
                    <!-- Araçlar -->
                    <div class="absolute bottom-3 right-3 flex space-x-2">
                        <button id="voice-btn" onclick="toggleVoiceInput()" class="bg-white hover:bg-red-50 text-gray-500 hover:text-red-500 p-3 rounded-full shadow-md transition-all border border-gray-100" title="Sesli Yaz">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                        <button onclick="toggleAIMenu()" class="bg-white hover:bg-indigo-50 text-indigo-500 p-3 rounded-full shadow-md transition-all border border-gray-100 flex items-center" title="AI Asistan">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- AI Menü -->
                <div id="ai-menu" class="hidden mt-3 bg-white border border-indigo-100 rounded-xl p-3 shadow-lg animate-fade-in">
                    <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                        <button onclick="useAI('summarize')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="file-text" class="w-4 h-4 mr-2 text-indigo-500"></i> Özetle</button>
                        <button onclick="useAI('fix')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="check-circle" class="w-4 h-4 mr-2 text-green-500"></i> Düzelt</button>
                        <button onclick="useAI('expand')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="maximize-2" class="w-4 h-4 mr-2 text-blue-500"></i> Genişlet</button>
                        <button onclick="useAI('categorize')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="tag" class="w-4 h-4 mr-2 text-purple-500"></i> Kategori</button>
                        <button onclick="useAI('todo')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="list-todo" class="w-4 h-4 mr-2 text-orange-500"></i> Yapılacaklar</button>
                        <button onclick="useAI('translate')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="languages" class="w-4 h-4 mr-2 text-teal-500"></i> Çeviri (EN)</button>
                        <button onclick="useAI('email')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="mail" class="w-4 h-4 mr-2 text-red-500"></i> E-posta Taslağı</button>
                        <button onclick="useAI('brainstorm')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="lightbulb" class="w-4 h-4 mr-2 text-yellow-500"></i> Fikir Üret</button>
                        <button onclick="useAI('quiz')" class="ai-btn flex items-center p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-600"><i data-lucide="help-circle" class="w-4 h-4 mr-2 text-pink-500"></i> Soru Hazırla</button>
                        <button onclick="useAI('title')" class="col-span-2 ai-btn flex items-center justify-center p-2 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-sm text-indigo-700 font-medium mt-1"><i data-lucide="type" class="w-4 h-4 mr-2"></i> ✨ Başlık Öner</button>
                    </div>
                    <div id="ai-loading" class="hidden text-center py-2"><div class="loader mx-auto"></div></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-100 flex justify-between bg-white rounded-b-3xl">
                <button onclick="deleteCurrentNote()" id="delete-btn" class="text-red-400 hover:text-red-600 px-4 py-2 text-sm font-medium hidden">Sil</button>
                <div class="flex space-x-3 ml-auto">
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 px-4 py-2 text-sm font-medium">İptal</button>
                    <button onclick="saveNote()" class="bg-gray-900 hover:bg-black text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg transform active:scale-95 transition-all">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[70] flex flex-col space-y-2 pointer-events-none"></div>

    <script>
        // API Key Management
        let userApiKey = localStorage.getItem('gemini_api_key') || "";
        const systemApiKey = ""; 

        const CATEGORIES = {
            'tarih': { label: 'Tarih', theme: 'theme-tarih' },
            'dini': { label: 'Dini', theme: 'theme-dini' },
            'siyasi': { label: 'Siyasi', theme: 'theme-siyasi' },
            'egitim': { label: 'Eğitim', theme: 'theme-egitim' },
            'guncel': { label: 'Güncel', theme: 'theme-guncel' },
            'kisisel': { label: 'Kişisel', theme: 'theme-kisisel' },
            'is': { label: 'İş & Proje', theme: 'theme-is' },
            'diger': { label: 'Diğer', theme: 'theme-diger' },
        };

        let allNotes = [];
        let currentFilter = 'all';
        let isListening = false;
        let isStealthMode = false;
        let recognition = null;
        let selectedCategory = 'guncel';

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initCategorySelector();
            setupVoiceRecognition();
            if(userApiKey) document.getElementById('api-key-input').value = userApiKey;
        });

        // --- Settings / API Key Functions ---
        function toggleSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                userApiKey = key;
                showToast("API Anahtarı kaydedildi!", "success");
            } else {
                localStorage.removeItem('gemini_api_key');
                userApiKey = "";
                showToast("API Anahtarı silindi.", "info");
            }
            toggleSettingsModal();
        }

        function initCategorySelector() {
            const container = document.getElementById('category-selector');
            container.innerHTML = '';
            Object.keys(CATEGORIES).forEach(key => {
                const btn = document.createElement('button');
                const isActive = key === selectedCategory;
                const themeClass = `btn-${CATEGORIES[key].theme}`;
                // Modal içinde butonlar sade olsun ama seçili olan parlasın
                const activeClass = isActive ? `bg-gray-800 text-white border-gray-800 shadow-md transform scale-105` : `bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100`;
                
                // Kategori seçimi için özel renkleri kullanmak yerine modern sade butonlar
                // Ancak "active" durumu için o kategorinin rengini verelim mi? Hayır, modalda karmaşa olmasın.
                
                btn.className = `px-4 py-1.5 rounded-full text-xs font-bold border transition-all duration-200 ${isActive ? 'bg-gray-900 text-white ring-2 ring-offset-1 ring-gray-900' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
                btn.textContent = CATEGORIES[key].label;
                btn.onclick = () => selectCategory(key);
                container.appendChild(btn);
            });
        }

        function selectCategory(key) {
            selectedCategory = key;
            initCategorySelector();
        }

        window.renderNotes = (notes) => {
            allNotes = notes;
            const grid = document.getElementById('notes-grid');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            
            grid.innerHTML = '';
            
            const filtered = notes.filter(note => {
                const matchesFilter = currentFilter === 'all' || note.category === currentFilter;
                const matchesSearch = (note.title || '').toLowerCase().includes(searchVal) || (note.content || '').toLowerCase().includes(searchVal);
                return matchesFilter && matchesSearch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10 font-caveat text-2xl flex flex-col items-center"><i data-lucide="ghost" class="w-12 h-12 mb-2 opacity-50"></i>Aradığınız notu bulamadım...</div>`;
                lucide.createIcons();
                return;
            }

            filtered.forEach((note, index) => {
                const catInfo = CATEGORIES[note.category] || CATEGORIES['guncel'];
                const theme = catInfo.theme;
                const rotation = Math.floor(Math.random() * 4) - 2; // Daha hafif dönüş
                
                const div = document.createElement('div');
                div.className = `post-it ${theme} shadow-md cursor-pointer flex flex-col h-64`;
                div.style.transform = `rotate(${rotation}deg)`;
                div.onclick = (e) => { if(!e.target.closest('.action-btn')) openEditModal(note); };

                // Markdown'ı temizle ve kısalt
                let preview = note.content || '';
                if(preview.length > 130) preview = preview.substring(0, 130) + '...';

                div.innerHTML = `
                    <div class="tape-section"></div>
                    
                    <!-- Kategori Rengine Göre Koyu Başlık Alanı -->
                    <div class="card-header p-4 pt-6 pb-2 border-b border-black/5 flex-none relative">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] font-bold uppercase tracking-widest opacity-80 border border-current px-1.5 rounded">${catInfo.label}</span>
                            <span class="text-[10px] font-bold opacity-70">${new Date(note.updatedAt?.seconds * 1000).toLocaleDateString('tr-TR', {day:'numeric', month:'short'})}</span>
                        </div>
                        <h3 class="font-bold text-lg leading-tight font-caveat tracking-wide">${note.title || 'İsimsiz Not'}</h3>
                    </div>

                    <!-- Kategori Rengine Göre Açık İçerik Alanı -->
                    <div class="card-body p-4 flex-1 overflow-hidden relative group">
                        <div class="text-sm leading-relaxed opacity-90 font-kalam">${marked.parse(preview)}</div>
                        
                        <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="action-btn p-1.5 bg-white/60 backdrop-blur rounded-full hover:bg-white text-gray-700 shadow-sm transition-all transform hover:scale-110" onclick="event.stopPropagation(); openEditModal(allNotes.find(n => n.id === '${note.id}'))">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
            lucide.createIcons();
        };

        function toggleStealthMode() {
            const body = document.body;
            isStealthMode = !isStealthMode;
            
            if (isStealthMode) {
                body.classList.add('stealth-mode');
                if (!isListening) toggleVoiceInput(true);
                document.getElementById('note-modal').classList.add('hidden');
                showToast("Gizli Mod Aktif.", "warning");
            } else {
                body.classList.remove('stealth-mode');
                if (isListening) {
                    toggleVoiceInput(false);
                    const content = document.getElementById('note-content').value;
                    if(content.trim().length > 0) setTimeout(() => toggleNewNoteModal(true), 500);
                }
            }
        }

        function filterNotes(category) {
            currentFilter = category;
            
            // Tüm butonları resetle
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-gray-800', 'text-white', 'ring-2', 'ring-offset-2');
                // Orijinal sınıflarını koru ama 'active' classını kaldır
            });
            
            // Aktif butonu bul ve işaretle (basit string match ile)
            // Daha sağlam yol: ID veya data attribute kullanmak ama bu yapı içinde:
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => {
                if(b.onclick.toString().includes(`'${category}'`)) {
                    b.classList.add('active'); // CSS'de tanımlı active stillerini alacak
                }
            });
            
            renderNotes(allNotes);
        }

        function searchNotes() { renderNotes(allNotes); }

        function toggleNewNoteModal(keepContent = false) {
            document.getElementById('note-id').value = '';
            document.getElementById('note-title').value = '';
            if(!keepContent) document.getElementById('note-content').value = '';
            
            document.getElementById('delete-btn').classList.add('hidden');
            document.getElementById('ai-menu').classList.add('hidden');
            selectedCategory = 'guncel';
            initCategorySelector();
            openModalUI();
        }

        function openEditModal(note) {
            document.getElementById('note-id').value = note.id;
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('note-content').value = note.content || '';
            document.getElementById('delete-btn').classList.remove('hidden');
            document.getElementById('ai-menu').classList.add('hidden');
            selectedCategory = note.category || 'guncel';
            initCategorySelector();
            openModalUI();
        }

        function openModalUI() {
            const modal = document.getElementById('note-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('hidden');
            setTimeout(() => panel.classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            const panel = document.getElementById('modal-panel');
            panel.classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('note-modal').classList.add('hidden');
                if(isListening && !isStealthMode) toggleVoiceInput(); 
            }, 300);
        }

        async function saveNote() {
            const id = document.getElementById('note-id').value;
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value.trim();
            
            if(!content && !title) { showToast("Boş kağıt asılmaz!", "warning"); return; }

            const noteData = { title, content, category: selectedCategory };

            if(id) await window.updateNoteInDb(id, noteData);
            else await window.addNoteToDb(noteData);
            
            closeModal();
            showToast("Not duvara asıldı!", "success");
        }

        async function deleteCurrentNote() {
            const id = document.getElementById('note-id').value;
            if(confirm("Bu notu yırtıp atmak istiyor musun?")) {
                await window.deleteNoteFromDb(id);
                closeModal();
                showToast("Not çöpe atıldı.", "info");
            }
        }

        function setupVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.continuous = true; 
                recognition.interimResults = true; 

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                    }
                    const textarea = document.getElementById('note-content');
                    if(finalTranscript) {
                        textarea.value += (textarea.value ? ' ' : '') + finalTranscript;
                        if(isStealthMode) document.getElementById('stealth-transcript').textContent = textarea.value.slice(-100);
                    }
                };
                recognition.onerror = (e) => { if(isListening && e.error !== 'aborted') try { recognition.start(); } catch(x){} };
                recognition.onend = () => { if(isListening) try { recognition.start(); } catch(x){} else updateMicUI(); };
            }
        }

        function toggleVoiceInput(forceState = null) {
            if(!recognition) return;
            isListening = (forceState !== null) ? forceState : !isListening;
            updateMicUI();
            if(isListening) { try { recognition.start(); if(!isStealthMode) showToast("Dinliyorum...", "info"); } catch(e) {} } 
            else { try { recognition.stop(); } catch(e) {} }
        }

        function updateMicUI() {
            const btn = document.getElementById('voice-btn');
            if(isListening) {
                btn.classList.add('mic-active');
                btn.innerHTML = '<i data-lucide="mic-off" class="w-5 h-5"></i>';
            } else {
                btn.classList.remove('mic-active');
                btn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i>';
            }
            lucide.createIcons();
        }

        function toggleAIMenu() { document.getElementById('ai-menu').classList.toggle('hidden'); }

        async function useAI(action) {
            const content = document.getElementById('note-content').value;
            if(!content) return;

            const activeKey = userApiKey || systemApiKey;
            if (!activeKey) {
                showToast("Lütfen ayarlardan API Anahtarınızı girin!", "warning");
                toggleSettingsModal();
                return;
            }

            const loader = document.getElementById('ai-loading');
            loader.classList.remove('hidden');

            let prompt = "";
            if(action === 'summarize') prompt = `Aşağıdaki metni Türkçe olarak Post-it'e sığacak şekilde çok kısa özetle:\n\n${content}`;
            if(action === 'fix') prompt = `Bu metni Türkçe imla kurallarına göre düzelt:\n\n${content}`;
            if(action === 'expand') prompt = `Bu fikri biraz daha detaylandır (Türkçe):\n\n${content}`;
            if(action === 'categorize') prompt = `Metni analiz et ve sadece tek kelimeyle kategorisini yaz (tarih, dini, siyasi, egitim, guncel, kisisel, is, diger): \n\n${content}`;
            if(action === 'todo') prompt = `Aşağıdaki metinden yola çıkarak mantıklı bir "Yapılacaklar Listesi" oluştur (- [ ] Görev):\n\n${content}`;
            if(action === 'translate') prompt = `Aşağıdaki metni İngilizceye çevir:\n\n${content}`;
            if(action === 'title') prompt = `Kısa, çarpıcı Türkçe başlık öner (sadece başlık):\n\n${content}`;
            if(action === 'email') prompt = `Profesyonel e-posta taslağı yaz (Türkçe):\n\n${content}`;
            if(action === 'brainstorm') prompt = `Konuyla ilgili 5 yaratıcı fikir öner:\n\n${content}`;
            if(action === 'quiz') prompt = `Zorlu 1 adet çoktan seçmeli soru ve cevabını hazırla:\n\n${content}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message || "API Hatası");

                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if(resultText) {
                    if(action === 'categorize') {
                        const cleanCat = resultText.trim().toLowerCase();
                        let found = false;
                        Object.keys(CATEGORIES).forEach(k => {
                            if(cleanCat.includes(k)) {
                                selectCategory(k);
                                showToast(`Kategori: ${CATEGORIES[k].label}`, "success");
                                found = true;
                            }
                        });
                        if(!found) showToast("Kategori anlaşılamadı.", "info");
                    } else if (action === 'title') {
                        document.getElementById('note-title').value = resultText.trim();
                        showToast("Başlık önerildi!", "success");
                    } else {
                        const textarea = document.getElementById('note-content');
                        let label = 'AI Sonuç';
                        if(action === 'todo') label = 'Liste';
                        if(action === 'translate') label = 'Çeviri';
                        if(action === 'email') label = 'E-posta';
                        if(action === 'brainstorm') label = 'Fikirler';
                        if(action === 'quiz') label = 'Soru';
                        
                        textarea.value += `\n\n-- AI (${label}) --\n${resultText}`;
                        showToast("Tamamlandı!", "success");
                    }
                }
            } catch (error) {
                console.error(error);
                showToast("API Hatası: Anahtarınızı kontrol edin.", "error");
            } finally {
                loader.classList.add('hidden');
                toggleAIMenu();
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { 'success': 'bg-green-600', 'error': 'bg-red-600', 'warning': 'bg-orange-500', 'info': 'bg-gray-800' };
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-xl flex items-center text-sm font-medium animate-fade-in`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
