<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barış'ın Akıllı Not Defteri</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Kalam:wght@300;400;700&family=Merriweather:wght@300;400;700&family=Courier+Prime:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Değişkenler
        window.firebaseData = { db: null, auth: null, user: null, active: false };
        window.localNotes = [];
        // Silinenleri kalıcı hafızada tut
        window.deletedIds = JSON.parse(localStorage.getItem('baris_deleted_ids') || "[]");

        const savedApiKey = localStorage.getItem('fb_api_key');
        const savedAppId = localStorage.getItem('fb_app_id');
        const defaultProject = "sekilli-totem-481514-c5";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: savedApiKey || "DEMO_KEY", 
            authDomain: `${defaultProject}.firebaseapp.com`,
            projectId: defaultProject,
            storageBucket: `${defaultProject}.firebasestorage.app`,
            messagingSenderId: "519295049418",
            appId: savedAppId || "DEMO_APP_ID"
        };

        async function initApp() {
            // Önce yerel veriyi yükle ve render et
            window.loadLocalNotes();

            if (firebaseConfig.apiKey === "DEMO_KEY" || firebaseConfig.apiKey.includes("BURAYA")) {
                console.log("Yerel modda çalışılıyor.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                window.firebaseData.auth = auth;
                window.firebaseData.db = db;

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    window.firebaseData.user = user;
                    if (user) {
                        window.firebaseData.active = true;
                        document.getElementById('cloud-icon').classList.replace('text-gray-300', 'text-green-500');
                        initLiveListener(user.uid);
                    }
                });
            } catch (e) { console.error("Firebase Hatası:", e); }
        }

        let unsubscribe = null;
        function initLiveListener(uid) {
            if (unsubscribe) unsubscribe();
            const q = collection(window.firebaseData.db, 'artifacts', defaultProject, 'users', uid, 'notes');
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const cloudNotes = [];
                snapshot.forEach(d => {
                    // ID Kara listede ise ASLA alma
                    if (!window.deletedIds.includes(d.id)) {
                        cloudNotes.push({ id: d.id, ...d.data() });
                    }
                });
                window.syncNotes(cloudNotes);
            });
        }

        initApp();

        // --- VERİ YÖNETİMİ ---

        window.loadLocalNotes = () => {
            const saved = localStorage.getItem('baris_notes');
            if (saved) {
                window.localNotes = JSON.parse(saved);
                // Silinmişleri yerelden de temizle (Güvenlik önlemi)
                window.localNotes = window.localNotes.filter(n => !window.deletedIds.includes(n.id));
                render(window.localNotes);
            }
        };

        window.saveLocalToDisk = () => {
            localStorage.setItem('baris_notes', JSON.stringify(window.localNotes));
            localStorage.setItem('baris_deleted_ids', JSON.stringify(window.deletedIds));
            // render çağrısını burada yapmıyoruz, UI'ı manuel güncelleyeceğiz ki titreme olmasın
        };

        window.syncNotes = (cloudNotes) => {
            const noteMap = new Map();
            // Yerel notları koy
            window.localNotes.forEach(n => noteMap.set(n.id, n));
            // Bulut notlarını koy (yereli ezer)
            cloudNotes.forEach(n => {
                if (!window.deletedIds.includes(n.id)) {
                    noteMap.set(n.id, n);
                }
            });
            
            window.localNotes = Array.from(noteMap.values());
            window.saveLocalToDisk();
            render(window.localNotes); // Sadece sync olduğunda toplu render
        };

        window.saveNoteToStorage = async (note) => {
            const noteId = note.id || 'loc_' + Date.now();
            const localNote = { ...note, id: noteId, updatedAt: Date.now() };
            
            // Eğer daha önce silmişsek, kara listeden çıkar (Geri getirme)
            const delIndex = window.deletedIds.indexOf(noteId);
            if (delIndex > -1) {
                window.deletedIds.splice(delIndex, 1);
                localStorage.setItem('baris_deleted_ids', JSON.stringify(window.deletedIds));
            }

            // Yerele Kaydet
            const existingIdx = window.localNotes.findIndex(n => n.id === noteId);
            if (existingIdx > -1) window.localNotes[existingIdx] = localNote;
            else window.localNotes.push(localNote);
            
            window.saveLocalToDisk();
            render(window.localNotes); // Anında göster

            // Buluta Kaydet
            if (window.firebaseData.active) {
                const col = collection(window.firebaseData.db, 'artifacts', defaultProject, 'users', window.firebaseData.user.uid, 'notes');
                if (noteId.startsWith('loc_')) {
                    try {
                        if(!note.id) {
                            await addDoc(col, { ...note, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                        }
                    } catch(e) {}
                } else {
                    updateDoc(doc(col, noteId), { ...note, updatedAt: serverTimestamp() });
                }
            }
            return noteId;
        };

        // --- AGRESİF SİLME FONKSİYONU ---
        window.deleteNoteFromStorage = async (id) => {
            // 1. GÖRSEL YOK ETME (EN ÖNEMLİSİ)
            // HTML'den elemanı bul ve anında DOM'dan sök
            const cardElement = document.querySelector(`[data-note-id="${id}"]`);
            if (cardElement) {
                cardElement.style.transition = "all 0.3s ease-out";
                cardElement.style.opacity = "0";
                cardElement.style.transform = "scale(0.9)";
                setTimeout(() => cardElement.remove(), 300);
            }

            // 2. KARA LİSTEYE EKLE (Geri gelmesini engelle)
            if (!window.deletedIds.includes(id)) {
                window.deletedIds.push(id);
                localStorage.setItem('baris_deleted_ids', JSON.stringify(window.deletedIds));
            }

            // 3. YEREL VERİDEN SİL
            window.localNotes = window.localNotes.filter(n => n.id !== id);
            window.saveLocalToDisk();

            // 4. BULUTTAN SİL (Arka planda)
            if (window.firebaseData.active && !id.startsWith('loc_')) {
                try {
                    deleteDoc(doc(window.firebaseData.db, 'artifacts', defaultProject, 'users', window.firebaseData.user.uid, 'notes', id));
                } catch(e) { console.error("Bulut silme hatası:", e); }
            }
        };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 32px 32px;
        }

        .font-hand { font-family: 'Kalam', cursive; }
        .font-serif { font-family: 'Merriweather', serif; }
        .font-mono { font-family: 'Courier Prime', monospace; }
        .font-sans { font-family: 'Inter', sans-serif; }

        .note-card {
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        /* Kart İçi Scrollbar */
        .card-scroll { overflow-y: auto; scrollbar-width: thin; }
        .card-scroll::-webkit-scrollbar { width: 4px; }
        .card-scroll::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 4px; }

        /* Kategori Renkleri */
        .cat-tarih { background: #fee2e2; border-top: 5px solid #ef4444; }
        .cat-dini { background: #dcfce7; border-top: 5px solid #22c55e; }
        .cat-siyasi { background: #dbeafe; border-top: 5px solid #3b82f6; }
        .cat-egitim { background: #fef3c7; border-top: 5px solid #f59e0b; }
        .cat-guncel { background: #cffafe; border-top: 5px solid #06b6d4; }
        .cat-kisisel { background: #fae8ff; border-top: 5px solid #d946ef; }
        .cat-is { background: #f1f5f9; border-top: 5px solid #64748b; }
        .cat-diger { background: #ffffff; border-top: 5px solid #9ca3af; }

        .fab {
            position: fixed; bottom: 24px; right: 24px; width: 64px; height: 64px;
            border-radius: 50%; background: #4f46e5; color: white;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; z-index: 40;
        }
        .fab:active { transform: scale(0.90); }

        /* Vurgular */
        .highlight-important { color: #c2410c; font-weight: 700; background-color: #ffedd5; padding: 0 2px; border-radius: 2px; }
        .highlight-blue { color: #1d4ed8; font-weight: 600; }

        [contenteditable]:empty:before { content: attr(placeholder); color: #9ca3af; display: block; }

        body.stealth-mode { background: #000 !important; overflow: hidden; }
        body.stealth-mode header, body.stealth-mode main, body.stealth-mode .fab { opacity: 0; pointer-events: none; }
        body.stealth-mode #stealth-overlay { display: flex; }

        .loader { width: 24px; height: 24px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes micPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }
        .mic-active { animation: micPulse 1.5s infinite; background-color: #fee2e2 !important; color: #ef4444 !important; border-color: #ef4444 !important; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-200">
                    <i data-lucide="book-open-check" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-gray-800">Barış'ın Defteri</h1>
            </div>
            
            <div class="flex items-center gap-1">
                <i data-lucide="cloud" id="cloud-icon" class="w-5 h-5 text-gray-300 mr-2 transition-colors" title="Bulut Durumu"></i>
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="openWhatsAppMode()" class="p-2 rounded-full hover:bg-green-50 text-green-600"><i data-lucide="smartphone" class="w-5 h-5"></i></button>
                <button onclick="toggleStealth()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="eye-off" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Kategoriler -->
        <div class="overflow-x-auto py-2 px-4 no-scrollbar">
            <div class="flex gap-2 max-w-5xl mx-auto min-w-max">
                <button onclick="filter('all')" class="cat-btn active bg-gray-800 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-md transition-all">Tümü</button>
                <button onclick="filter('tarih')" class="cat-btn bg-white border text-red-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-red-50 transition-all">Tarih</button>
                <button onclick="filter('dini')" class="cat-btn bg-white border text-green-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-green-50 transition-all">Dini</button>
                <button onclick="filter('siyasi')" class="cat-btn bg-white border text-blue-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-blue-50 transition-all">Siyasi</button>
                <button onclick="filter('egitim')" class="cat-btn bg-white border text-yellow-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-yellow-50 transition-all">Eğitim</button>
                <button onclick="filter('guncel')" class="cat-btn bg-white border text-cyan-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-cyan-50 transition-all">Güncel</button>
                <button onclick="filter('is')" class="cat-btn bg-white border text-slate-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-slate-50 transition-all">İş</button>
                <button onclick="filter('diger')" class="cat-btn bg-white border text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-gray-50 transition-all">Diğer</button>
            </div>
        </div>
    </header>

    <!-- Ana Alan -->
    <main class="flex-1 overflow-y-auto p-4 pb-24">
        <div class="max-w-5xl mx-auto space-y-6">
            <!-- Arama -->
            <div class="relative group">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
                <input type="text" id="searchInput" onkeyup="search()" placeholder="Notlarda ara..." class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl shadow-sm border-none focus:ring-2 focus:ring-indigo-100 transition-all outline-none placeholder-gray-400 font-medium">
            </div>

            <!-- Liste -->
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            
            <div id="empty-state" class="hidden text-center py-20 opacity-50">
                <i data-lucide="feather" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                <p class="text-xl font-hand">Henüz not yok, hemen bir şeyler karala!</p>
            </div>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="openModal()" class="fab hover:scale-110 transition-transform">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <!-- NOT MODALI (Tam Ekran) -->
    <div id="note-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-0 md:inset-x-0 md:bottom-6 md:top-6 md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-3xl bg-white md:rounded-3xl shadow-2xl flex flex-col overflow-hidden transition-transform duration-300 translate-y-full" id="modal-panel">
            
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white z-10">
                <button onclick="closeModal()" class="md:hidden mr-3 text-gray-500"><i data-lucide="arrow-left"></i></button>
                <input type="text" id="note-title" placeholder="Başlık" class="text-xl font-bold bg-transparent border-none focus:ring-0 p-0 w-full text-gray-800 placeholder-gray-300">
                <div class="flex gap-2 items-center">
                    <button onclick="deleteCurrentNote()" id="btn-delete" class="hidden text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors" title="Sil"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    <button onclick="saveNote()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg active:scale-95 transition-transform">Kaydet</button>
                </div>
            </div>

            <!-- Kategori -->
            <div class="px-6 py-3 bg-gray-50/50 flex gap-2 overflow-x-auto no-scrollbar border-b border-gray-100" id="modal-cats"></div>

            <!-- Editör -->
            <div class="flex-1 relative bg-white group overflow-y-auto">
                <div id="note-content" contenteditable="true" class="w-full h-full min-h-[50vh] p-6 lg:p-8 outline-none text-lg leading-relaxed font-hand text-gray-700" placeholder="Notunuzu buraya yazın..."></div>
                
                <div id="ai-loading" class="absolute inset-0 bg-white/90 z-20 hidden flex-col items-center justify-center">
                    <div class="loader mb-3"></div>
                    <p class="text-sm font-bold text-indigo-600 animate-pulse">Yapay Zeka Düşünüyor...</p>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="editor-toolbar p-3 pb-safe border-t border-gray-100">
                <div class="flex justify-between items-center max-w-lg mx-auto">
                    <div class="flex gap-1">
                        <button onclick="setFont('font-hand')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-hand text-sm">Aa</button>
                        <button onclick="setFont('font-serif')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-serif text-sm">Aa</button>
                        <button onclick="setFont('font-sans')" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 font-sans text-sm">Aa</button>
                    </div>
                    <div class="w-px h-6 bg-gray-200 mx-2"></div>
                    <div class="flex gap-3">
                        <button onclick="toggleVoice()" id="mic-btn" class="p-3 rounded-full bg-red-50 text-red-500 hover:bg-red-100 transition-colors shadow-sm"><i data-lucide="mic" class="w-5 h-5"></i></button>
                        <div class="relative">
                            <button onclick="toggleAiMenu()" class="p-3 rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors shadow-sm ring-2 ring-indigo-100 ring-offset-1"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                            <div id="ai-popup" class="absolute bottom-16 right-0 w-64 bg-white rounded-2xl shadow-2xl border border-gray-100 p-2 hidden z-30 transform origin-bottom-right transition-all">
                                <div class="text-xs font-bold text-gray-400 px-3 py-1 uppercase tracking-wider">İçerik Geliştirme</div>
                                <button onclick="runAI('continue')" class="w-full text-left px-3 py-2 hover:bg-indigo-50 rounded-lg text-sm flex items-center gap-2 text-gray-700"><i data-lucide="pen-tool" class="w-4 h-4 text-orange-500"></i> Devamını Getir</button>
                                <button onclick="runAI('formal')" class="w-full text-left px-3 py-2 hover:bg-indigo-50 rounded-lg text-sm flex items-center gap-2 text-gray-700"><i data-lucide="briefcase" class="w-4 h-4 text-blue-500"></i> Resmileştir</button>
                                <button onclick="runAI('keypoints')" class="w-full text-left px-3 py-2 hover:bg-indigo-50 rounded-lg text-sm flex items-center gap-2 text-gray-700"><i data-lucide="list" class="w-4 h-4 text-purple-500"></i> Ana Fikirler</button>
                                <div class="h-px bg-gray-100 my-1"></div>
                                <div class="text-xs font-bold text-gray-400 px-3 py-1 uppercase tracking-wider">Araçlar</div>
                                <button onclick="runAI('fix')" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm flex items-center gap-2 text-gray-600"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Düzelt</button>
                                <button onclick="runAI('summarize')" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg text-sm flex items-center gap-2 text-gray-600"><i data-lucide="file-text" class="w-4 h-4 text-gray-500"></i> Özetle</button>
                                <button onclick="openWhatsAppMode()" class="w-full text-left px-3 py-2 hover:bg-green-50 rounded-lg text-sm flex items-center gap-2 text-green-700 font-medium"><i data-lucide="smartphone" class="w-4 h-4"></i> WhatsApp Modu</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div id="wp-modal" class="fixed inset-0 z-[60] hidden bg-black/90 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-gray-900 rounded-3xl overflow-hidden shadow-2xl flex flex-col h-[85vh]">
            <div class="p-4 flex justify-between items-center bg-gray-800">
                <button onclick="closeWp()" class="text-white p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
                <span class="text-xs font-mono text-gray-400 bg-black/30 px-2 py-1 rounded" id="wp-count">0/700</span>
            </div>
            <div id="wp-preview" class="flex-1 flex items-center justify-center p-6 transition-colors duration-500 relative" style="background-color: #25D366;">
                <textarea id="wp-text" class="w-full bg-transparent border-none text-center text-white text-2xl font-['Patrick_Hand'] focus:ring-0 resize-none overflow-hidden placeholder-white/50" rows="10" placeholder="Durum yazısı..." oninput="checkWpLimit()"></textarea>
            </div>
            <div class="p-4 bg-gray-900 space-y-4 border-t border-gray-800">
                <div class="flex justify-center gap-4 overflow-x-auto py-2">
                    <button onclick="setWpColor('#25D366')" class="w-8 h-8 rounded-full bg-[#25D366] border-2 border-white/20 hover:scale-110 transition-transform"></button>
                    <button onclick="setWpColor('#FF5252')" class="w-8 h-8 rounded-full bg-[#FF5252] border-2 border-white/20 hover:scale-110 transition-transform"></button>
                    <button onclick="setWpColor('#448AFF')" class="w-8 h-8 rounded-full bg-[#448AFF] border-2 border-white/20 hover:scale-110 transition-transform"></button>
                    <button onclick="setWpColor('#7C4DFF')" class="w-8 h-8 rounded-full bg-[#7C4DFF] border-2 border-white/20 hover:scale-110 transition-transform"></button>
                    <button onclick="setWpColor('#212121')" class="w-8 h-8 rounded-full bg-[#212121] border-2 border-white/20 hover:scale-110 transition-transform"></button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="runAI('whatsapp')" class="bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 border border-gray-700 transition-colors"><i data-lucide="sparkles" class="w-4 h-4 text-indigo-400"></i> AI Sığdır</button>
                    <button onclick="saveWpToNote()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-900/20 transition-colors">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ayarlar Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl transform transition-all scale-100">
            <h2 class="text-xl font-bold mb-4 flex items-center text-gray-800"><i data-lucide="settings" class="mr-2 text-indigo-600"></i> Ayarlar</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">Gemini API Key</label>
                <input type="password" id="gemini-key" class="w-full border border-indigo-100 bg-indigo-50 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Firebase Config</label>
                <input type="password" id="fb-key" class="w-full border rounded-lg p-2 text-sm mb-2" placeholder="API Key">
                <input type="text" id="fb-app" class="w-full border rounded-lg p-2 text-sm" placeholder="App ID">
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-100 mt-4">
                <button onclick="downloadBackup()" class="text-green-600 text-sm font-bold flex items-center hover:bg-green-50 px-3 py-2 rounded-lg transition-colors"><i data-lucide="download" class="w-4 h-4 mr-2"></i> Yedekle</button>
                <div class="flex gap-2">
                    <button onclick="toggleSettings()" class="text-gray-500 text-sm hover:bg-gray-100 px-4 py-2 rounded-lg transition-colors">İptal</button>
                    <button onclick="saveSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md transition-colors">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Onay Modalı -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl text-center">
            <div class="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Notu Sil?</h3>
            <p class="text-sm text-gray-500 mb-6">Bu işlem geri alınamaz.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">Vazgeç</button>
                <button onclick="performDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium shadow-md">Evet, Sil</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[80] space-y-2 pointer-events-none"></div>

    <div id="stealth-overlay" class="fixed inset-0 bg-black z-[100] hidden flex flex-col items-center justify-center text-gray-800 text-xs select-none" onclick="toggleStealth()">
        <div class="mb-4 animate-pulse text-red-600 font-bold">● REC</div>
        <p class="text-gray-900">Çıkmak için dokun</p>
        <div id="stealth-text" class="mt-4 opacity-20 max-w-xs text-center truncate font-mono text-gray-600"></div>
    </div>

    <script>
        let notes = [];
        let currentFilter = 'all';
        let currentNoteId = null;
        let recognition = null;
        let isListening = false;
        let currentFont = 'font-hand';
        let currentCat = 'guncel';
        let noteToDeleteId = null;

        const CATEGORIES = { 'tarih': 'Tarih', 'dini': 'Dini', 'siyasi': 'Siyasi', 'egitim': 'Eğitim', 'guncel': 'Güncel', 'is': 'İş', 'kisisel': 'Kişisel', 'diger': 'Diğer' };

        document.addEventListener('DOMContentLoaded', () => {
            window.loadLocalNotes();
            setupVoice();
            lucide.createIcons();
            document.getElementById('gemini-key').value = localStorage.getItem('gemini_api_key') || "";
            document.getElementById('fb-key').value = localStorage.getItem('fb_api_key') || "";
            document.getElementById('fb-app').value = localStorage.getItem('fb_app_id') || "";
        });

        window.loadLocalNotes = () => {
            const saved = localStorage.getItem('baris_notes');
            if (saved) {
                window.localNotes = JSON.parse(saved);
                render(window.localNotes);
            } else {
                window.localNotes = [];
                render([]);
            }
        };

        window.saveLocalToDisk = (shouldRender = true) => {
            localStorage.setItem('baris_notes', JSON.stringify(window.localNotes));
            if(shouldRender) render(window.localNotes);
        };

        window.syncNotes = (cloudNotes) => {
            const noteMap = new Map();
            window.localNotes.forEach(n => noteMap.set(n.id, n));
            // Eğer cloudNotes'ta olmayan ve 'deletedNoteIds' içinde olan varsa, onu yerelden de sil (senkronize silme)
            cloudNotes.forEach(n => {
                if (!window.deletedNoteIds.has(n.id)) noteMap.set(n.id, n);
            });
            window.localNotes = Array.from(noteMap.values());
            window.saveLocalToDisk();
        };

        function render(data) {
            const grid = document.getElementById('notes-grid');
            const empty = document.getElementById('empty-state');
            grid.innerHTML = '';
            const filtered = data.filter(n => currentFilter === 'all' || n.category === currentFilter).sort((a,b) => (b.updatedAt?.seconds || b.updatedAt) - (a.updatedAt?.seconds || a.updatedAt));
            if (filtered.length === 0) empty.classList.remove('hidden'); else empty.classList.add('hidden');

            filtered.forEach(note => {
                const el = document.createElement('div');
                const catClass = `cat-${note.category || 'diger'}`;
                const fontClass = note.font || 'font-hand';
                const date = new Date((note.updatedAt?.seconds || note.updatedAt / 1000) * 1000).toLocaleDateString('tr-TR');
                
                el.setAttribute('data-note-id', note.id);
                el.className = `note-card ${catClass} flex flex-col h-56 animate-fade-in bg-white group`;
                
                el.innerHTML = `
                    <div class="p-5 flex-1 overflow-hidden relative flex flex-col">
                        <!-- Düzenle Butonu -->
                        <button onclick="event.stopPropagation(); openNote('${note.id}')" class="absolute top-2 right-2 text-indigo-500 bg-white/80 rounded-full p-2 opacity-100 transition-opacity hover:bg-indigo-100 z-30 shadow-sm" title="Düzenle">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        
                        <!-- Sil Butonu -->
                        <button onclick="event.stopPropagation(); deleteNoteFromCard('${note.id}')" class="absolute top-2 left-2 text-red-400 bg-white/80 rounded-full p-2 opacity-100 transition-opacity hover:bg-red-100 z-30 shadow-sm" title="Sil">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>

                        <div class="flex justify-between items-start mb-2 pr-8 pl-8 pointer-events-none">
                            <h3 class="font-bold text-lg leading-tight line-clamp-2">${note.title || 'Başlıksız'}</h3>
                        </div>
                        
                        <!-- Kaydırılabilir İçerik Alanı -->
                        <div class="flex-1 overflow-y-auto card-scroll pr-2 relative z-10" onmousedown="event.stopPropagation()">
                            <div class="text-sm opacity-90 ${fontClass} text-gray-800 break-words">${note.content || ''}</div>
                        </div>

                        <div class="absolute bottom-0 left-0 right-0 p-4 pt-4 bg-gradient-to-t from-white via-white/90 to-transparent flex justify-between items-end pointer-events-none">
                            <span class="text-[10px] uppercase font-bold opacity-60 border border-current px-2 py-0.5 rounded tracking-wide">${CATEGORIES[note.category]}</span>
                            <span class="text-xs opacity-50 font-medium">${date}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
            lucide.createIcons();
        }

        function filter(cat) {
            currentFilter = cat;
            document.querySelectorAll('.cat-btn').forEach(b => { b.classList.remove('bg-gray-800', 'text-white'); b.classList.add('bg-white'); });
            const btn = Array.from(document.querySelectorAll('.cat-btn')).find(b => b.innerText === CATEGORIES[cat] || (cat === 'all' && b.innerText === 'Tümü'));
            if(btn) { btn.classList.add('bg-gray-800', 'text-white'); btn.classList.remove('bg-white'); }
            render(window.localNotes);
        }

        function search() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtered = window.localNotes.filter(n => (n.title+n.content).toLowerCase().includes(val));
            render(filtered);
        }

        function openModal() {
            currentNoteId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').innerHTML = ''; // Div temizle
            document.getElementById('btn-delete').classList.add('hidden');
            renderCats('guncel');
            setFont('font-hand');
            document.getElementById('note-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-panel').classList.remove('translate-y-full'), 10);
        }

        function openNote(id) {
            const note = window.localNotes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('note-content').innerHTML = note.content || ''; // HTML yükle
            document.getElementById('btn-delete').classList.remove('hidden');
            renderCats(note.category || 'guncel');
            setFont(note.font || 'font-hand');
            document.getElementById('note-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-panel').classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            document.getElementById('modal-panel').classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('note-modal').classList.add('hidden');
                document.getElementById('ai-popup').classList.add('hidden');
                if(isListening) toggleVoice();
            }, 300);
        }

        function renderCats(selected) {
            currentCat = selected;
            const div = document.getElementById('modal-cats');
            div.innerHTML = '';
            Object.keys(CATEGORIES).forEach(k => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1.5 rounded-full text-xs font-bold border transition-all whitespace-nowrap ${k === selected ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`;
                btn.innerText = CATEGORIES[k];
                btn.onclick = () => { renderCats(k); };
                div.appendChild(btn);
            });
        }

        function setFont(fontClass) {
            currentFont = fontClass;
            const area = document.getElementById('note-content');
            area.classList.remove('font-hand', 'font-serif', 'font-mono', 'font-sans');
            area.classList.add(fontClass);
        }

        async function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').innerHTML; // HTML al
            
            if (!title && !document.getElementById('note-content').innerText.trim()) return showToast('Boş not kaydedilemez', 'error');
            
            const noteData = { id: currentNoteId, title, content, category: currentCat, font: currentFont };
            
            // ID güncellensin
            const savedId = await window.saveNoteToStorage(noteData);
            currentNoteId = savedId; 
            
            showToast('Kaydedildi', 'success');
        }

        function openConfirmModal(id) {
            noteToDeleteId = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            noteToDeleteId = null;
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        async function performDelete() {
            if (!noteToDeleteId) return;
            const idToDelete = noteToDeleteId;
            closeConfirmModal();
            if (currentNoteId === idToDelete) closeModal();
            await window.deleteNoteFromStorage(idToDelete);
            showToast('Not silindi', 'success');
        }

        function deleteCurrentNote() { if (currentNoteId) openConfirmModal(currentNoteId); }
        function deleteNoteFromCard(id) { openConfirmModal(id); }

        function toggleAiMenu() { document.getElementById('ai-popup').classList.toggle('hidden'); }

        async function runAI(action) {
            toggleAiMenu();
            const contentDiv = document.getElementById('note-content');
            const contentText = contentDiv.innerText; 
            
            if(!contentText.trim()) return showToast("Önce bir şeyler yazmalısın!", "error");
            const apiKey = localStorage.getItem('gemini_api_key');
            if(!apiKey) return showToast("Ayarlardan API Anahtarı girmelisin!", "error");

            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('ai-loading').classList.add('flex');

            let prompt = "";
            const htmlInstruction = "Cevabı HTML formatında ver (<html> etiketi olmadan, sadece içerik). Önemli yerleri <span class='highlight-important'>bu şekilde</span>, ikincil önemli yerleri <span class='highlight-blue'>bu şekilde</span> vurgula. Satır sonlarına <br> koy.";

            if (action === 'fix') prompt = `Bu metni Türkçe imla kurallarına göre düzelt: ${contentText}. ${htmlInstruction}`;
            else if (action === 'summarize') prompt = `Bu metni Türkçe özetle: ${contentText}. ${htmlInstruction}`;
            else if (action === 'expand') prompt = `Bu metni genişlet: ${contentText}. ${htmlInstruction}`;
            else if (action === 'continue') prompt = `Devamını getir (2-3 cümle): ${contentText}. Sadece eklediğin kısmı ver. ${htmlInstruction}`;
            else if (action === 'formal') prompt = `Resmi dille yaz: ${contentText}. ${htmlInstruction}`;
            else if (action === 'keypoints') prompt = `Ana fikirleri çıkar: ${contentText}. ${htmlInstruction}`;
            else if (action === 'whatsapp') prompt = `WhatsApp durumu (max 700 karakter) için kısalt, emoji ekle, renk seç (1-5). Format: METİN|||RENK_NO. Metin: ${contentText}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (action === 'whatsapp') {
                    const parts = result.split('|||');
                    document.getElementById('wp-text').value = parts[0].trim();
                    if(parts[1]) {
                        const colors = ['#25D366', '#FF5252', '#448AFF', '#7C4DFF', '#212121'];
                        setWpColor(colors[parseInt(parts[1])-1] || colors[0]);
                    }
                    closeModal();
                    document.getElementById('wp-modal').classList.remove('hidden');
                } else {
                    if (action === 'continue') {
                        contentDiv.innerHTML += " " + result;
                    } else {
                        contentDiv.innerHTML = result;
                    }
                }
                showToast("Tamamlandı!", "success");
            } catch (error) { console.error(error); showToast("Hata: " + error.message, "error"); } 
            finally { 
                document.getElementById('ai-loading').classList.add('hidden');
                document.getElementById('ai-loading').classList.remove('flex');
            }
        }

        function openWhatsAppMode() {
            const currentContent = document.getElementById('note-content').innerText;
            document.getElementById('wp-text').value = currentContent;
            checkWpLimit();
            document.getElementById('wp-modal').classList.remove('hidden');
        }
        function closeWp() { document.getElementById('wp-modal').classList.add('hidden'); }
        function setWpColor(c) { document.getElementById('wp-preview').style.backgroundColor = c; }
        function checkWpLimit() {
            const len = document.getElementById('wp-text').value.length;
            document.getElementById('wp-count').innerText = `${len}/700`;
            document.getElementById('wp-count').className = len > 700 ? "text-red-500 font-bold" : "text-gray-400 font-mono";
        }
        function saveWpToNote() {
            const text = document.getElementById('wp-text').value;
            if(!currentNoteId) window.saveNoteToStorage({title: 'Durum Yazısı', content: text, category: 'diger', font: 'font-hand'});
            else { document.getElementById('note-content').innerHTML = text; saveNote(); }
            closeWp();
            showToast("Kaydedildi", "success");
        }

        function setupVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = (e) => {
                    let final = '';
                    for (let i = e.resultIndex; i < e.results.length; ++i) if(e.results[i].isFinal) final += e.results[i][0].transcript;
                    if(final) {
                        const el = document.getElementById('note-content');
                        el.innerHTML += (el.innerHTML ? ' ' : '') + final;
                        if(isListening && document.body.classList.contains('stealth-mode')) document.getElementById('stealth-text').innerText = final;
                    }
                };
                recognition.onend = () => { if(isListening) try{recognition.start()}catch{} else updateMicState(false); };
            }
        }
        function toggleVoice() {
            if(!recognition) return showToast("Mikrofon desteklenmiyor", "error");
            isListening = !isListening;
            updateMicState(isListening);
            if(isListening) { try{ recognition.start(); showToast("Dinliyorum...", "success"); }catch{} } else { try{ recognition.stop(); }catch{} }
        }
        function updateMicState(on) {
            const btn = document.getElementById('mic-btn');
            if(on) { btn.classList.add('mic-active', 'bg-red-100', 'text-red-600'); btn.innerHTML = '<i data-lucide="mic-off"></i>'; }
            else { btn.classList.remove('mic-active', 'bg-red-100', 'text-red-600'); btn.innerHTML = '<i data-lucide="mic"></i>'; }
            lucide.createIcons();
        }

        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function saveSettings() {
            localStorage.setItem('gemini_api_key', document.getElementById('gemini-key').value.trim());
            localStorage.setItem('fb_api_key', document.getElementById('fb-key').value.trim());
            localStorage.setItem('fb_app_id', document.getElementById('fb-app').value.trim());
            toggleSettings();
            showToast("Ayarlar kaydedildi", "success");
            setTimeout(() => location.reload(), 500);
        }
        function downloadBackup() {
            const blob = new Blob([JSON.stringify(window.localNotes, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `yedek-${Date.now()}.json`;
            a.click();
        }
        function toggleStealth() {
            document.body.classList.toggle('stealth-mode');
            if(document.body.classList.contains('stealth-mode')) { if(!isListening) toggleVoice(); }
        }
        function showToast(msg, type) {
            const div = document.createElement('div');
            div.className = `px-4 py-2 rounded-lg shadow-lg text-white text-sm font-bold animate-fade-in ${type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            div.innerText = msg;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>


